<!DOCTYPE html>
<html lang="es" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Estados Financieros - Agronare</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#F0FDF4',
                            100: '#DCFCE7',
                            200: '#BBF7D0',
                            300: '#86EFAC',
                            400: '#4ADE80',
                            500: '#22C55E',
                            600: '#16A34A',
                            700: '#15803D',
                            800: '#166534',
                            900: '#14532D',
                        },
                        secondary: {
                            500: '#4dab6b',
                        },
                        tertiary: {
                            50: '#F0F9FF',
                            100: '#E0F2FE',
                            200: '#BAE6FD',
                            300: '#7DD3FC',
                            400: '#38BDF8',
                            500: '#0EA5E9',
                            600: '#0284C7',
                            700: '#0369A1',
                            800: '#075985',
                            900: '#0C4A6E',
                        },
                        danger: {
                            500: '#EF4444',
                        },
                        dark: {
                            bg: '#020617',
                            card: '#111827',
                            text: '#D1D5DB',
                        },
                        light: {
                            bg: '#F9FAFB',
                            card: '#FFFFFF',
                            text: '#1F2937',
                        },
                        border: {
                            light: '#E5E7EB',
                            dark: '#374151',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            transition: all 0.3s ease-in-out;
        }

        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-in-out;
            z-index: 2000;
        }

        .welcome-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .main-app-container.hidden {
            display: none;
        }

        /* Utiliza las variables CSS de Tailwind para un tema dinámico */
        .sidebar {
            width: 256px;
            z-index: 1000;
        }

        .main-content {
            margin-left: 256px;
        }

        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                height: 100vh;
                top: 0;
                left: 0;
                bottom: 0;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-button {
                display: block;
            }

            .section-title {
                padding-top: 50px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .message.info {
                bottom: 1rem;
                left: 1rem;
                right: 1rem;
            }
        }

        /* Animación del spinner */
        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .no-print {
            visibility: visible;
        }

        @media print {
            .no-print {
                visibility: hidden;
                display: none;
            }
        }

        .pdf-cover {
            background: linear-gradient(135deg, theme('colors.primary.600'), theme('colors.primary.800'));
        }

        .dark .pdf-cover {
            background: linear-gradient(135deg, theme('colors.dark.bg'), theme('colors.gray.900'));
        }

        .pdf-cover-text {
            color: #fff;
        }

        .pdf-report h1,
        .pdf-report h2,
        .pdf-report h3,
        .pdf-report h4 {
            font-family: 'Inter', sans-serif;
            color: theme('colors.primary.800');
        }

        .dark .pdf-report h1,
        .dark .pdf-report h2,
        .dark .pdf-report h3,
        .dark .pdf-report h4 {
            color: theme('colors.primary.300');
        }

        .pdf-report table {
            width: 100%;
            border-collapse: collapse;
        }

        .pdf-report th,
        .pdf-report td {
            padding: 12px 16px;
            border-bottom: 1px solid theme('colors.gray.200');
        }

        .dark .pdf-report th,
        .dark .pdf-report td {
            border-bottom: 1px solid theme('colors.gray.700');
        }

        .pdf-report tr:nth-child(even) {
            background-color: theme('colors.gray.50');
        }

        .dark .pdf-report tr:nth-child(even) {
            background-color: theme('colors.gray.800');
        }

        .highlight-row {
            background-color: theme('colors.primary.200') !important;
            color: theme('colors.primary.900');
            font-weight: bold;
        }

        .dark .highlight-row {
            background-color: theme('colors.primary.800') !important;
            color: theme('colors.white');
        }

        /* Estilos para el efecto de marca de agua en las páginas del PDF */
        .pdf-watermark {
            position: relative;
        }

        /* Este pseudo-elemento crea el fondo de marca de agua para cada página del PDF */
        .pdf-watermark::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--watermark-image);
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            /* Se ajusta sin distorsionar */
            opacity: var(--watermark-opacity);
            z-index: -1;
            pointer-events: none;
        }

        /* Asegura que el contenido del PDF tenga un fondo para que la marca de agua no se extienda a toda la página */
        .pdf-content-with-watermark {
            background-color: white;
            /* O el color de fondo de tu reporte */
            position: relative;
            z-index: 2;
        }
    </style>
</head>

<body class="bg-light-bg text-light-text dark:bg-dark-bg dark:text-dark-text transition-colors duration-300">
    <!-- Pantalla de bienvenida -->
    <div id="welcome-screen" class="welcome-screen bg-light-bg dark:bg-dark-bg text-light-text dark:text-dark-text">
        <div class="text-center animate-fade-in-up transition-all duration-500">
            <div class="flex items-center justify-center mb-6">
                <svg xmlns="http://www.w3.org/2000/svg"
                    class="h-20 w-20 text-primary-600 dark:text-primary-400 animate-bounce-slow" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
            </div>
            <h1 class="text-5xl font-extrabold mb-4 text-gray-800 dark:text-gray-100">Agronare Financiero</h1>
            <p class="text-lg mb-8 max-w-lg mx-auto font-light text-gray-600 dark:text-gray-300">
                Tu herramienta intuitiva para analizar estados financieros.
            </p>
            <button onclick="enterApp()"
                class="px-8 py-4 bg-primary-600 text-white rounded-full font-bold text-lg shadow-lg hover:bg-primary-700 transform hover:scale-105 transition-all duration-300">
                Ingresar a la App
            </button>
        </div>
    </div>
    <!-- Contenedor principal de la app, inicialmente oculto -->
    <div id="main-app-container" class="main-app-container hidden">
        <!-- Botón para menú en móvil -->
        <button
            class="mobile-menu-button fixed top-4 left-4 z-[1001] bg-primary-600 dark:bg-primary-500 text-white p-3 rounded-full shadow-lg transition-colors duration-300 hidden"
            id="mobile-menu-toggle">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        <div class="flex min-h-screen">
            <!-- Barra lateral de navegación -->
            <div class="sidebar fixed inset-y-0 left-0 bg-gray-800 dark:bg-gray-900 text-white p-6 overflow-y-auto transition-transform duration-300 ease-in-out"
                id="sidebar">
                <div class="text-center mb-8 pb-4 border-b border-gray-700">
                    <h1 class="text-lg font-semibold flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-400" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        <span>Agronare Financiero</span>
                    </h1>
                </div>
                <ul class="space-y-2">
                    <li><button
                            class="tab-button active w-full py-3 px-4 bg-primary-600 dark:bg-primary-500 text-white text-left rounded-lg transition-all duration-300 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 flex items-center gap-3 font-semibold"
                            data-tab="balance">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2">
                                </path>
                                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                            </svg>Balance General</button></li>
                    <li><button
                            class="tab-button w-full py-3 px-4 text-gray-300 text-left rounded-lg transition-all duration-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 flex items-center gap-3"
                            data-tab="resultados">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="20" x2="18" y2="10"></line>
                                <line x1="12" y1="20" x2="12" y2="4"></line>
                                <line x1="6" y1="20" x2="6" y2="14"></line>
                            </svg>Estado de Resultados</button></li>
                    <li><button
                            class="tab-button w-full py-3 px-4 text-gray-300 text-left rounded-lg transition-all duration-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 flex items-center gap-3"
                            data-tab="ratios">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m12 14 4-4"></path>
                                <path d="M3.34 19a10 10 0 1 1 17.32 0"></path>
                            </svg>Ratios Financieros</button></li>
                    <li><button
                            class="tab-button w-full py-3 px-4 text-gray-300 text-left rounded-lg transition-all duration-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 flex items-center gap-3"
                            data-tab="comprobacion">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                            </svg>Comprobación</button></li>
                    <li><button
                            class="tab-button w-full py-3 px-4 text-gray-300 text-left rounded-lg transition-all duration-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 flex items-center gap-3"
                            data-tab="analisis-ia">✨ Análisis con IA</button></li>
                    <li><button
                            class="tab-button w-full py-3 px-4 text-gray-300 text-left rounded-lg transition-all duration-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 flex items-center gap-3"
                            data-tab="comparativo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M8 3v3a2 2 0 0 1-2 2H3"></path>
                                <path
                                    d="M21 8v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3l3 -3 3 3h3a2 2 0 0 1 2 2z">
                                </path>
                                <path d="M12 18v-7.5"></path>
                                <path d="M12 7.5l-2.5 2.5"></path>
                                <path d="M12 7.5l2.5 2.5"></path>
                            </svg>Comparativo</button></li>
                    <li><button
                            class="tab-button w-full py-3 px-4 text-gray-300 text-left rounded-lg transition-all duration-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 flex items-center gap-3"
                            data-tab="vista-previa">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>Vista Previa</button></li>
                    <li><button
                            class="tab-button w-full py-3 px-4 text-gray-300 text-left rounded-lg transition-all duration-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 flex items-center gap-3"
                            data-tab="exportar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>Exportar</button></li>
                </ul>
            </div>

            <!-- Botón de cambio de tema -->
            <button id="theme-toggle"
                class="no-print fixed top-4 right-4 z-[1001] bg-gray-200 dark:bg-gray-700 p-2 rounded-full shadow-lg transition-colors duration-300 flex items-center justify-center">
                <svg id="sun-icon" class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <svg id="moon-icon" class="h-6 w-6 text-gray-500 hidden" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
            <!-- Contenido principal -->
            <div class="main-content flex-1 p-8 transition-all duration-300 ease-in-out">
                <div id="notification-area" class="fixed bottom-4 right-4 z-[1002] flex flex-col items-end space-y-2">
                </div>

                <!-- Pestaña de Balance General -->
                <div id="balance" class="tab-content active animate-fadeIn">
                    <h2
                        class="text-2xl font-bold text-primary-600 dark:text-primary-400 border-b-2 border-primary-600 dark:border-primary-400 pb-2 mb-6 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                        </svg>Balance General Detallado
                    </h2>
                    <div id="balance-message"></div>

                    <div class="flex flex-col md:flex-row gap-8">
                        <!-- Columna de Activos -->
                        <div class="flex-1">
                            <!-- ACTIVO -->
                            <div
                                class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-6 shadow-md transition-colors duration-300">
                                <h3
                                    class="text-xl font-semibold text-light-text dark:text-dark-text pb-3 mb-6 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                                    ACTIVO</h3>
                                <!-- Activo Corriente -->
                                <div
                                    class="p-4 rounded-xl mb-6 border-l-4 border-primary-600 dark:border-primary-500 bg-gray-50 dark:bg-gray-800 transition-colors duration-300">
                                    <h4
                                        class="text-lg font-bold text-primary-600 dark:text-primary-500 mb-4 transition-colors duration-300">
                                        Activo Corriente</h4>
                                    <!-- Disponibilidades -->
                                    <div
                                        class="p-4 rounded-md mb-4 bg-light-card dark:bg-dark-card shadow-inner transition-colors duration-300">
                                        <h5
                                            class="text-base font-semibold text-light-text dark:text-dark-text pb-2 mb-2 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                                            Disponibilidades</h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Caja</label>
                                                <input type="text" id="cash" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Bancos</label>
                                                <input type="text" id="banks" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Inversiones
                                                    Temporales</label>
                                                <input type="text" id="short-term-investments" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                    </div>
                                    <div
                                        class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                                        <span>Total Disponibilidades</span>
                                        <span id="total-cash"></span>
                                    </div>
                                    <!-- Cuentas por Cobrar Comerciales -->
                                    <div
                                        class="p-4 rounded-md mb-4 bg-light-card dark:bg-dark-card shadow-inner transition-colors duration-300">
                                        <h5
                                            class="text-base font-semibold text-light-text dark:text-dark-text pb-2 mb-2 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                                            Cuentas por Cobrar Comerciales</h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Clientes
                                                    Nacionales</label>
                                                <input type="text" id="domestic-clients" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Clientes
                                                    Extranjeros</label>
                                                <input type="text" id="foreign-clients" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Documentos
                                                    por Cobrar</label>
                                                <input type="text" id="notes-receivable" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Provisión
                                                    para Incobrables (-)</label>
                                                <input type="text" id="bad-debt-provision" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                    </div>
                                    <div
                                        class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                                        <span>Total Cuentas por Cobrar</span>
                                        <span id="total-accounts-receivable"></span>
                                    </div>
                                    <!-- Inventarios -->
                                    <div
                                        class="p-4 rounded-md mb-4 bg-light-card dark:bg-dark-card shadow-inner transition-colors duration-300">
                                        <h5
                                            class="text-base font-semibold text-light-text dark:text-dark-text pb-2 mb-2 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                                            Inventarios</h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Materias
                                                    Primas</label>
                                                <input type="text" id="raw-materials" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Productos
                                                    en Proceso</label>
                                                <input type="text" id="work-in-progress" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Productos
                                                    Terminados</label>
                                                <input type="text" id="finished-goods" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Mercancías
                                                    en Tránsito</label>
                                                <input type="text" id="goods-in-transit" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                    </div>
                                    <div
                                        class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                                        <span>Total Inventarios</span>
                                        <span id="total-inventory"></span>
                                    </div>
                                    <!-- Otros Activos Corrientes -->
                                    <div
                                        class="p-4 rounded-md mb-4 bg-light-card dark:bg-dark-card shadow-inner transition-colors duration-300">
                                        <h5
                                            class="text-base font-semibold text-light-text dark:text-dark-text pb-2 mb-2 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                                            Otros Activos Corrientes</h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Impuestos
                                                    por Recuperar</label>
                                                <input type="text" id="tax-refunds" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Intereses
                                                    por Cobrar</label>
                                                <input type="text" id="interest-receivable" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Anticipos
                                                    a Proveedores</label>
                                                <input type="text" id="supplier-advances" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Otros</label>
                                                <input type="text" id="other-current-assets" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                    </div>
                                    <div
                                        class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                                        <span>Total Otros Activos Corrientes</span>
                                        <span id="total-other-current-assets"></span>
                                    </div>
                                </div>
                                <!-- Activo No Corriente -->
                                <div
                                    class="p-4 rounded-xl mb-6 border-l-4 border-primary-600 dark:border-primary-500 bg-gray-50 dark:bg-gray-800 transition-colors duration-300">
                                    <h4
                                        class="text-lg font-bold text-primary-600 dark:text-primary-500 mb-4 transition-colors duration-300">
                                        Activo No Corriente</h4>
                                    <!-- Propiedad, Planta y Equipo -->
                                    <div
                                        class="p-4 rounded-md mb-4 bg-light-card dark:bg-dark-card shadow-inner transition-colors duration-300">
                                        <h5
                                            class="text-base font-semibold text-light-text dark:text-dark-text pb-2 mb-2 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                                            Propiedad, Planta y Equipo</h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Terrenos</label>
                                                <input type="text" id="land" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Edificios</label>
                                                <input type="text" id="buildings" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Maquinaria
                                                    y Equipo</label>
                                                <input type="text" id="machinery" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Muebles
                                                    y Enseres</label>
                                                <input type="text" id="furniture" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Depreciación
                                                    Acumulada (-)</label>
                                                <input type="text" id="accumulated-depreciation" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Equipo
                                                    de Transporte</label>
                                                <input type="text" id="transportation-equipment" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                    </div>
                                    <div
                                        class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                                        <span>Total Propiedad, Planta y Equipo</span>
                                        <span id="total-ppe-net"></span>
                                    </div>
                                    <!-- Intangibles -->
                                    <div
                                        class="p-4 rounded-md mb-4 bg-light-card dark:bg-dark-card shadow-inner transition-colors duration-300">
                                        <h5
                                            class="text-base font-semibold text-light-text dark:text-dark-text pb-2 mb-2 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                                            Intangibles</h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Marcas
                                                    y Patentes</label>
                                                <input type="text" id="trademarks-patents" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Licencias</label>
                                                <input type="text" id="licenses" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Amortización
                                                    Acumulada (-)</label>
                                                <input type="text" id="accumulated-amortization" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Software</label>
                                                <input type="text" id="software" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                    </div>
                                    <div
                                        class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                                        <span>Total Intangibles</span>
                                        <span id="total-intangibles"></span>
                                    </div>
                                    <!-- Inversiones Permanentes -->
                                    <div
                                        class="p-4 rounded-md mb-4 bg-light-card dark:bg-dark-card shadow-inner transition-colors duration-300">
                                        <h5
                                            class="text-base font-semibold text-light-text dark:text-dark-text pb-2 mb-2 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                                            Inversiones Permanentes</h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Acciones
                                                    de Inversión</label>
                                                <input type="text" id="investment-shares" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Bonos</label>
                                                <input type="text" id="bonds" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Otras
                                                    Inversiones</label>
                                                <input type="text" id="other-investments" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                    </div>
                                    <div
                                        class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                                        <span>Total Inversiones Permanentes</span>
                                        <span id="total-investments"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Columna de Pasivo y Patrimonio -->
                        <div class="flex-1">
                            <!-- PASIVO Y PATRIMONIO -->
                            <div
                                class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-6 shadow-md transition-colors duration-300">
                                <h3
                                    class="text-xl font-semibold text-light-text dark:text-dark-text pb-3 mb-6 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                                    PASIVO Y PATRIMONIO</h3>
                                <!-- Pasivo Corriente -->
                                <div
                                    class="p-4 rounded-xl mb-6 border-l-4 border-primary-600 dark:border-primary-500 bg-gray-50 dark:bg-gray-800 transition-colors duration-300">
                                    <h4
                                        class="text-lg font-bold text-primary-600 dark:text-primary-500 mb-4 transition-colors duration-300">
                                        Pasivo Corriente</h4>
                                    <!-- Proveedores -->
                                    <div
                                        class="p-4 rounded-md mb-4 bg-light-card dark:bg-dark-card shadow-inner transition-colors duration-300">
                                        <h5
                                            class="text-base font-semibold text-light-text dark:text-dark-text pb-2 mb-2 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                                            Proveedores</h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Proveedores
                                                    Nacionales</label>
                                                <input type="text" id="domestic-suppliers" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Proveedores
                                                    Extranjeros</label>
                                                <input type="text" id="foreign-suppliers" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Documentos
                                                    por Pagar</label>
                                                <input type="text" id="notes-payable" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                    </div>
                                    <div
                                        class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                                        <span>Total Proveedores</span>
                                        <span id="total-suppliers"></span>
                                    </div>
                                    <!-- Obligaciones Financieras -->
                                    <div
                                        class="p-4 rounded-md mb-4 bg-light-card dark:bg-dark-card shadow-inner transition-colors duration-300">
                                        <h5
                                            class="text-base font-semibold text-light-text dark:text-dark-text pb-2 mb-2 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                                            Obligaciones Financieras</h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Préstamos
                                                    Bancarios a Corto Plazo</label>
                                                <input type="text" id="short-term-bank-loans" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Sobregiros
                                                    Bancarios</label>
                                                <input type="text" id="bank-overdrafts" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                    </div>
                                    <div
                                        class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                                        <span>Total Obligaciones Financieras</span>
                                        <span id="total-short-term-loans"></span>
                                    </div>
                                    <!-- Obligaciones Fiscales -->
                                    <div
                                        class="p-4 rounded-md mb-4 bg-light-card dark:bg-dark-card shadow-inner transition-colors duration-300">
                                        <h5
                                            class="text-base font-semibold text-light-text dark:text-dark-text pb-2 mb-2 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                                            Obligaciones Fiscales</h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">IVA
                                                    por Pagar</label>
                                                <input type="text" id="vat-payable" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">ISR
                                                    por Pagar</label>
                                                <input type="text" id="income-tax-payable" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Otros
                                                    Impuestos</label>
                                                <input type="text" id="other-taxes" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                    </div>
                                    <div
                                        class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                                        <span>Total Obligaciones Fiscales</span>
                                        <span id="total-taxes"></span>
                                    </div>
                                    <!-- Otros Pasivos Corrientes -->
                                    <div
                                        class="p-4 rounded-md mb-4 bg-light-card dark:bg-dark-card shadow-inner transition-colors duration-300">
                                        <h5
                                            class="text-base font-semibold text-light-text dark:text-dark-text pb-2 mb-2 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                                            Otros Pasivos Corrientes</h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Anticipos
                                                    de Clientes</label>
                                                <input type="text" id="customer-advances" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Provisiones</label>
                                                <input type="text" id="provisions" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Dividendos
                                                    por Pagar</label>
                                                <input type="text" id="dividends-payable" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Otros</label>
                                                <input type="text" id="other-current-liabilities" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                    </div>
                                    <div
                                        class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                                        <span>Total Otros Pasivos Corrientes</span>
                                        <span id="total-other-current-liabilities"></span>
                                    </div>
                                </div>
                                <!-- Pasivo No Corriente -->
                                <div
                                    class="p-4 rounded-xl mb-6 border-l-4 border-primary-600 dark:border-primary-500 bg-gray-50 dark:bg-gray-800 transition-colors duration-300">
                                    <h4
                                        class="text-lg font-bold text-primary-600 dark:text-primary-500 mb-4 transition-colors duration-300">
                                        Pasivo No Corriente</h4>
                                    <div
                                        class="p-4 rounded-md mb-4 bg-light-card dark:bg-dark-card shadow-inner transition-colors duration-300">
                                        <h5
                                            class="text-base font-semibold text-light-text dark:text-dark-text pb-2 mb-2 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                                            Deuda a Largo Plazo</h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Préstamos
                                                    Bancarios a Largo Plazo</label>
                                                <input type="text" id="long-term-bank-loans" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Obligaciones
                                                    por Arrendamiento Financiero</label>
                                                <input type="text" id="finance-lease-obligations" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Otros
                                                    Pasivos a Largo Plazo</label>
                                                <input type="text" id="other-long-term-liabilities" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                    </div>
                                    <div
                                        class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                                        <span>Total Pasivo No Corriente</span>
                                        <span id="total-long-term-liabilities"></span>
                                    </div>
                                    <!-- Patrimonio -->
                                    <div
                                        class="p-4 rounded-xl mb-6 border-l-4 border-primary-600 dark:border-primary-500 bg-gray-50 dark:bg-gray-800 transition-colors duration-300">
                                        <h4
                                            class="text-lg font-bold text-primary-600 dark:text-primary-500 mb-4 transition-colors duration-300">
                                            Patrimonio</h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Capital
                                                    Social</label>
                                                <input type="text" id="capital-stock" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Prima
                                                    en Venta de Acciones</label>
                                                <input type="text" id="share-premium" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Reservas
                                                    Legales</label>
                                                <input type="text" id="legal-reserves" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Reservas
                                                    Facultativas</label>
                                                <input type="text" id="voluntary-reserves" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Resultados
                                                    Acumulados</label>
                                                <input type="text" id="accumulated-results" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Resultado
                                                    del Ejercicio</label>
                                                <input type="text" id="current-period-result" placeholder="$0.00"
                                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                            </div>
                                        </div>
                                    </div>
                                    <div
                                        class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                                        <span>Total Patrimonio</span>
                                        <span id="total-equity"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-4 mt-8">
                        <button
                            class="btn btn-primary bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all duration-300 flex items-center gap-2"
                            onclick="calculateBalance()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 20V10"></path>
                                <path d="M18 20V4"></path>
                                <path d="M6 20V16"></path>
                            </svg>Calcular Balance
                        </button>
                        <button
                            class="btn btn-outline border-2 border-border-light dark:border-border-dark text-gray-500 dark:text-gray-400 font-semibold py-3 px-6 rounded-lg transition-all duration-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center gap-2"
                            onclick="loadSampleBalanceData()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>Datos de Ejemplo
                        </button>
                        <button
                            class="btn btn-danger bg-danger-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all duration-300 flex items-center gap-2"
                            onclick="clearForm('balance')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path
                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                </path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                            </svg>Limpiar
                        </button>
                    </div>
                </div>

                <!-- Pestaña de Estado de Resultados -->
                <div id="resultados" class="tab-content animate-fadeIn hidden">
                    <h2
                        class="text-2xl font-bold text-primary-600 dark:text-primary-400 border-b-2 border-primary-600 dark:border-primary-400 pb-2 mb-6 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>Estado de Resultados Detallado
                    </h2>
                    <div id="resultados-message"></div>

                    <div
                        class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-6 shadow-md transition-colors duration-300">
                        <h3
                            class="text-xl font-semibold text-light-text dark:text-dark-text pb-3 mb-6 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                            INGRESOS</h3>
                        <div
                            class="p-4 rounded-xl mb-6 border-l-4 border-primary-600 dark:border-primary-500 bg-gray-50 dark:bg-gray-800 transition-colors duration-300">
                            <h4
                                class="text-lg font-bold text-primary-600 dark:text-primary-500 mb-4 transition-colors duration-300">
                                Ventas Netas</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Ventas
                                        Brutas</label>
                                    <input type="text" id="gross-sales" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Devoluciones
                                        sobre Ventas (-)</label>
                                    <input type="text" id="sales-returns" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Descuentos
                                        sobre Ventas (-)</label>
                                    <input type="text" id="sales-discounts" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Bonificaciones
                                        (-)</label>
                                    <input type="text" id="bonuses" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                            </div>
                        </div>
                        <div
                            class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                            <span>Total Ventas Netas</span>
                            <span id="total-net-sales"></span>
                        </div>
                        <!-- Otros Ingresos -->
                        <div
                            class="p-4 rounded-xl mb-6 border-l-4 border-primary-600 dark:border-primary-500 bg-gray-50 dark:bg-gray-800 transition-colors duration-300">
                            <h4
                                class="text-lg font-bold text-primary-600 dark:text-primary-500 mb-4 transition-colors duration-300">
                                Otros Ingresos</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Ingresos
                                        por Arrendamiento</label>
                                    <input type="text" id="rental-income" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Ingresos
                                        Financieros</label>
                                    <input type="text" id="financial-income" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Ganancia
                                        en Venta de Activos</label>
                                    <input type="text" id="asset-sale-gain" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Otros
                                        Ingresos</label>
                                    <input type="text" id="other-income" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                            </div>
                        </div>
                        <div
                            class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                            <span>Total Otros Ingresos</span>
                            <span id="total-other-income"></span>
                        </div>
                    </div>

                    <div
                        class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-6 shadow-md transition-colors duration-300">
                        <h3
                            class="text-xl font-semibold text-light-text dark:text-dark-text pb-3 mb-6 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                            COSTO DE VENTAS</h3>
                        <div
                            class="p-4 rounded-xl mb-6 border-l-4 border-primary-600 dark:border-primary-500 bg-gray-50 dark:bg-gray-800 transition-colors duration-300">
                            <h4
                                class="text-lg font-bold text-primary-600 dark:text-primary-500 mb-4 transition-colors duration-300">
                                Costo de Ventas</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Inventario
                                        Inicial</label>
                                    <input type="text" id="beginning-inventory" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Compras
                                        Netas</label>
                                    <input type="text" id="net-purchases" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Inventario
                                        Final (-)</label>
                                    <input type="text" id="ending-inventory" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Costo
                                        de Productos Terminados</label>
                                    <input type="text" id="finished-goods-cost" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                            </div>
                        </div>
                        <div
                            class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                            <span>Total Costo de Ventas</span>
                            <span id="total-cost-of-sales"></span>
                        </div>
                    </div>

                    <div
                        class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-6 shadow-md transition-colors duration-300">
                        <h3
                            class="text-xl font-semibold text-light-text dark:text-dark-text pb-3 mb-6 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                            GASTOS DE OPERACIÓN</h3>
                        <!-- Gastos de Venta -->
                        <div
                            class="p-4 rounded-xl mb-6 border-l-4 border-primary-600 dark:border-primary-500 bg-gray-50 dark:bg-gray-800 transition-colors duration-300">
                            <h4
                                class="text-lg font-bold text-primary-600 dark:text-primary-500 mb-4 transition-colors duration-300">
                                Gastos de Venta</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Sueldos
                                        y Salarios de Ventas</label>
                                    <input type="text" id="sales-salaries" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Comisiones
                                        de Ventas</label>
                                    <input type="text" id="sales-commissions" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Publicidad
                                        y Promoción</label>
                                    <input type="text" id="advertising" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Transporte
                                        de Mercancías</label>
                                    <input type="text" id="freight-out" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Otros
                                        Gastos de Venta</label>
                                    <input type="text" id="other-sales-expenses" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                            </div>
                        </div>
                        <div
                            class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                            <span>Total Gastos de Venta</span>
                            <span id="total-sales-expenses"></span>
                        </div>
                        <!-- Gastos de Administración -->
                        <div
                            class="p-4 rounded-xl mb-6 border-l-4 border-primary-600 dark:border-primary-500 bg-gray-50 dark:bg-gray-800 transition-colors duration-300">
                            <h4
                                class="text-lg font-bold text-primary-600 dark:text-primary-500 mb-4 transition-colors duration-300">
                                Gastos de Administración</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Sueldos
                                        y Salarios de Administración</label>
                                    <input type="text" id="admin-salaries" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Honorarios
                                        Profesionales</label>
                                    <input type="text" id="professional-fees" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Servicios
                                        Generales</label>
                                    <input type="text" id="general-services" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Mantenimiento
                                        de Oficinas</label>
                                    <input type="text" id="office-maintenance" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Depreciación
                                        de Activos Fijos</label>
                                    <input type="text" id="depreciation-expense" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Amortización
                                        de Intangibles</label>
                                    <input type="text" id="amortization-expense" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Otros
                                        Gastos de Administración</label>
                                    <input type="text" id="other-admin-expenses" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                            </div>
                        </div>
                        <div
                            class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                            <span>Total Gastos de Administración</span>
                            <span id="total-admin-expenses"></span>
                        </div>
                    </div>

                    <div
                        class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-6 shadow-md transition-colors duration-300">
                        <h3
                            class="text-xl font-semibold text-light-text dark:text-dark-text pb-3 mb-6 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                            GASTOS FINANCIEROS</h3>
                        <div
                            class="p-4 rounded-xl mb-6 border-l-4 border-primary-600 dark:border-primary-500 bg-gray-50 dark:bg-gray-800 transition-colors duration-300">
                            <h4
                                class="text-lg font-bold text-primary-600 dark:text-primary-500 mb-4 transition-colors duration-300">
                                Gastos Financieros</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Intereses
                                        Pagados</label>
                                    <input type="text" id="interest-expense" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Comisiones
                                        Bancarias</label>
                                    <input type="text" id="bank-commissions" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Pérdida
                                        en Cambio</label>
                                    <input type="text" id="exchange-loss" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Otros
                                        Gastos Financieros</label>
                                    <input type="text" id="other-financial-expenses" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                            </div>
                        </div>
                        <div
                            class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                            <span>Total Gastos Financieros</span>
                            <span id="total-financial-expenses"></span>
                        </div>
                    </div>

                    <div
                        class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-6 shadow-md transition-colors duration-300">
                        <h3
                            class="text-xl font-semibold text-light-text dark:text-dark-text pb-3 mb-6 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                            IMPUESTOS</h3>
                        <div
                            class="p-4 rounded-xl mb-6 border-l-4 border-primary-600 dark:border-primary-500 bg-gray-50 dark:bg-gray-800 transition-colors duration-300">
                            <h4
                                class="text-lg font-bold text-primary-600 dark:text-primary-500 mb-4 transition-colors duration-300">
                                Impuestos</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Impuesto
                                        Sobre la Renta (ISR)</label>
                                    <input type="text" id="income-tax" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Otros
                                        Impuestos</label>
                                    <input type="text" id="other-taxes-expense" placeholder="$0.00"
                                        class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                </div>
                            </div>
                        </div>
                        <div
                            class="p-4 bg-primary-100 dark:bg-primary-900 rounded-lg text-primary-800 dark:text-primary-200 font-bold mb-4 flex justify-between items-center">
                            <span>Total Impuestos</span>
                            <span id="total-taxes-expense"></span>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-4 mt-8">
                        <button
                            class="btn btn-primary bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all duration-300 flex items-center gap-2"
                            onclick="calculateResults()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 20V10"></path>
                                <path d="M18 20V4"></path>
                                <path d="M6 20V16"></path>
                            </svg>Calcular Resultados
                        </button>
                        <button
                            class="btn btn-outline border-2 border-border-light dark:border-border-dark text-gray-500 dark:text-gray-400 font-semibold py-3 px-6 rounded-lg transition-all duration-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center gap-2"
                            onclick="loadSampleResultsData()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>Datos de Ejemplo
                        </button>
                        <button
                            class="btn btn-danger bg-danger-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all duration-300 flex items-center gap-2"
                            onclick="clearForm('resultados')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path
                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                </path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                            </svg>Limpiar
                        </button>
                    </div>
                </div>

                <!-- Pestaña de Ratios Financieros -->
                <div id="ratios" class="tab-content animate-fadeIn hidden">
                    <h2
                        class="text-2xl font-bold text-primary-600 dark:text-primary-400 border-b-2 border-primary-600 dark:border-primary-400 pb-2 mb-6 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m12 14 4-4"></path>
                            <path d="M3.34 19a10 10 0 1 1 17.32 0"></path>
                        </svg>Ratios Financieros
                    </h2>
                    <div id="ratios-message"></div>

                    <div
                        class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-6 shadow-md transition-colors duration-300">
                        <h3
                            class="text-xl font-semibold text-light-text dark:text-dark-text pb-3 mb-6 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                            Modo de Visualización</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div>
                                <label for="ratio-mode"
                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Seleccionar
                                    Modo</label>
                                <select id="ratio-mode" onchange="switchRatioMode()"
                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                    <option value="bank">🏦 Modo Banco (Liquidez/Solvencia)</option>
                                    <option value="investor">💼 Modo Inversionista (Rentabilidad)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-6 shadow-md transition-colors duration-300">
                        <h3
                            class="text-xl font-semibold text-light-text dark:text-dark-text pb-3 mb-6 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                            Ratios Calculados</h3>
                        <div id="ratios-display">
                            <p class="text-gray-500">Ingrese datos en las secciones anteriores y calcule para ver los
                                ratios.</p>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-4 mt-8">
                        <button
                            class="btn btn-primary bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all duration-300 flex items-center gap-2"
                            onclick="calculateRatios()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 20V10"></path>
                                <path d="M18 20V4"></path>
                                <path d="M6 20V16"></path>
                            </svg>Calcular Ratios
                        </button>
                    </div>
                </div>

                <!-- Pestaña de Comprobación de Estados -->
                <div id="comprobacion" class="tab-content animate-fadeIn hidden">
                    <h2
                        class="text-2xl font-bold text-primary-600 dark:text-primary-400 border-b-2 border-primary-600 dark:border-primary-400 pb-2 mb-6 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                        </svg>Comprobación de Estados Financieros
                    </h2>
                    <div id="comprobacion-message"></div>

                    <div
                        class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-6 shadow-md transition-colors duration-300">
                        <h3
                            class="text-xl font-semibold text-light-text dark:text-dark-text pb-3 mb-6 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                            Verificación de Consistencia</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-4">Esta herramienta verifica que tus estados
                            financieros cuadren correctamente y que la información sea consistente.</p>

                        <div id="comprobacion-results" class="space-y-4">
                            <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <p class="text-sm text-blue-700 dark:text-blue-300">Haz clic en el botón de abajo para
                                    ejecutar la comprobación.</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-4 mt-8">
                        <button
                            class="btn btn-primary bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all duration-300 flex items-center gap-2"
                            onclick="checkFinancialStatements()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 6 9 17l-5-5" />
                            </svg>Comprobar Estados
                        </button>
                    </div>
                </div>

                <!-- Pestaña de Análisis con IA -->
                <div id="analisis-ia" class="tab-content animate-fadeIn hidden">
                    <h2
                        class="text-2xl font-bold text-primary-600 dark:text-primary-400 border-b-2 border-primary-600 dark:border-primary-400 pb-2 mb-6 flex items-center gap-3">
                        ✨ Análisis con IA
                    </h2>
                    <div id="ai-message"></div>

                    <div
                        class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-6 shadow-md transition-colors duration-300">
                        <h3
                            class="text-xl font-semibold text-light-text dark:text-dark-text pb-3 mb-6 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                            Análisis General</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-6">Obtén una visión general rápida del estado
                            financiero de tu empresa.</p>
                        <div class="flex flex-wrap gap-4">
                            <button id="ai-summary-btn"
                                class="btn btn-primary bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all duration-300 flex items-center gap-2"
                                onclick="generateAIAnalysis('summary')">📝 Generar Resumen Ejecutivo</button>
                            <button id="ai-swot-btn"
                                class="btn btn-primary bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all duration-300 flex items-center gap-2"
                                onclick="generateAIAnalysis('swot')">💪 Generar Fortalezas y Debilidades</button>
                            <button id="ai-recom-btn"
                                class="btn btn-primary bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all duration-300 flex items-center gap-2"
                                onclick="generateAIAnalysis('recommendations')">💡 Generar Recomendaciones</button>
                        </div>
                    </div>

                    <div
                        class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-6 shadow-md transition-colors duration-300">
                        <h3
                            class="text-xl font-semibold text-light-text dark:text-dark-text pb-3 mb-6 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                            Análisis de Ratios y Benchmarking</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-6">Compara tus ratios financieros con los
                            promedios de tu industria para obtener un contexto más amplio.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div>
                                <label for="industry-input"
                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Industria
                                    de la Empresa</label>
                                <input type="text" id="industry-input" placeholder="Ej: Agricultura, Tecnología, Retail"
                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-4 mt-8">
                            <button id="ai-benchmark-btn"
                                class="btn btn-primary bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all duration-300 flex items-center gap-2"
                                onclick="generateAIBenchmarkAnalysis()">🔬 Analizar Ratios vs. Industria</button>
                        </div>
                    </div>

                    <div
                        class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-6 shadow-md transition-colors duration-300">
                        <h3
                            class="text-xl font-semibold text-light-text dark:text-dark-text pb-3 mb-6 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                            Resultados del Análisis</h3>
                        <textarea id="ai-result-display" readonly
                            placeholder="Los resultados del análisis de la IA aparecerán aquí..."
                            class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark bg-light-card dark:bg-gray-800 transition-colors duration-300 min-h-[300px]"></textarea>
                    </div>
                </div>

                <!-- Pestaña de Comparativo -->
                <div id="comparativo" class="tab-content animate-fadeIn hidden">
                    <h2
                        class="text-2xl font-bold text-primary-600 dark:text-primary-400 border-b-2 border-primary-600 dark:border-primary-400 pb-2 mb-6 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M8 3v3a2 2 0 0 1-2 2H3"></path>
                            <path d="M21 8v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3l3 -3 3 3h3a2 2 0 0 1 2 2z">
                            </path>
                            <path d="M12 18v-7.5"></path>
                            <path d="M12 7.5l-2.5 2.5"></path>
                            <path d="M12 7.5l2.5 2.5"></path>
                        </svg>Comparativo de Periodos
                    </h2>
                    <div id="comparativo-message"></div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div
                            class="bg-light-card dark:bg-dark-card rounded-xl p-6 shadow-md transition-colors duration-300">
                            <h3 class="text-xl font-bold text-primary-600 dark:text-primary-500 mb-4">Periodo 1</h3>
                            <div class="mb-4">
                                <label for="period1-name"
                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Nombre
                                    del Periodo</label>
                                <input type="text" id="period1-name" placeholder="Ej: 2025-06"
                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                            </div>
                            <div class="mb-4">
                                <label for="period1-net-income"
                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Utilidad
                                    Neta</label>
                                <input type="text" id="period1-net-income" placeholder="$0.00"
                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                            </div>
                            <div class="mb-4">
                                <label for="period1-sales"
                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Ventas
                                    Netas</label>
                                <input type="text" id="period1-sales" placeholder="$0.00"
                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                            </div>
                        </div>
                        <div
                            class="bg-light-card dark:bg-dark-card rounded-xl p-6 shadow-md transition-colors duration-300">
                            <h3 class="text-xl font-bold text-primary-600 dark:text-primary-500 mb-4">Periodo 2</h3>
                            <div class="mb-4">
                                <label for="period2-name"
                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Nombre
                                    del Periodo</label>
                                <input type="text" id="period2-name" placeholder="Ej: 2025-07"
                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                            </div>
                            <div class="mb-4">
                                <label for="period2-net-income"
                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Utilidad
                                    Neta</label>
                                <input type="text" id="period2-net-income" placeholder="$0.00"
                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                            </div>
                            <div class="mb-4">
                                <label for="period2-sales"
                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Ventas
                                    Netas</label>
                                <input type="text" id="period2-sales" placeholder="$0.00"
                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-6 shadow-md transition-colors duration-300">
                        <h3
                            class="text-xl font-semibold text-light-text dark:text-dark-text pb-3 mb-6 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                            Gráfico Comparativo</h3>
                        <div class="h-[400px]">
                            <canvas id="comparison-chart" class="w-full h-full"></canvas>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-4 mt-8">
                        <button
                            class="btn btn-primary bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all duration-300 flex items-center gap-2"
                            onclick="generateComparison()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 20V10"></path>
                                <path d="M18 20V4"></path>
                                <path d="M6 20V16"></path>
                            </svg>Generar Comparativo
                        </button>
                        <button
                            class="btn btn-outline border-2 border-border-light dark:border-border-dark text-gray-500 dark:text-gray-400 font-semibold py-3 px-6 rounded-lg transition-all duration-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center gap-2"
                            onclick="loadSampleComparisonData()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>Datos de Ejemplo
                        </button>
                    </div>
                </div>

                <!-- Pestaña de Vista Previa -->
                <div id="vista-previa" class="tab-content animate-fadeIn hidden">
                    <h2
                        class="text-2xl font-bold text-primary-600 dark:text-primary-400 border-b-2 border-primary-600 dark:border-primary-400 pb-2 mb-6 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>Vista Previa del Reporte
                    </h2>
                    <div id="preview-message"></div>

                    <div class="bg-light-card dark:bg-dark-card rounded-xl p-8 shadow-2xl transition-colors duration-300"
                        id="report-preview">
                        <div
                            class="text-center mb-8 pb-8 border-b-2 border-border-light dark:border-border-dark transition-colors duration-300">
                            <div class="company-logo-preview w-32 h-32 mx-auto mb-4 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center font-bold text-gray-500 dark:text-gray-400 overflow-hidden border-4 border-border-light dark:border-border-dark transition-colors duration-300"
                                id="preview-logo">
                                <span>LOGO</span>
                            </div>
                            <h2 class="text-3xl font-bold text-primary-600 dark:text-primary-500 mb-2 transition-colors duration-300"
                                id="preview-company-name">Nombre de la Empresa</h2>
                            <p class="text-lg text-gray-500 dark:text-gray-400 transition-colors duration-300"
                                id="preview-period">Periodo: YYYY-MM</p>
                        </div>

                        <div id="preview-ai-summary"></div>

                        <div class="mb-8">
                            <h3
                                class="text-2xl font-semibold text-light-text dark:text-dark-text pb-2 mb-4 border-b-2 border-border-light dark:border-border-dark transition-colors duration-300">
                                Balance General</h3>
                            <div id="preview-balance-content" class="flex flex-col md:flex-row gap-4">
                                <div class="flex-1">
                                    <table class="w-full border-collapse" id="preview-balance-activos"></table>
                                </div>
                                <div class="flex-1">
                                    <table class="w-full border-collapse" id="preview-balance-pasivos"></table>
                                </div>
                            </div>
                        </div>

                        <div class="mb-8">
                            <h3
                                class="text-2xl font-semibold text-light-text dark:text-dark-text pb-2 mb-4 border-b-2 border-border-light dark:border-border-dark transition-colors duration-300">
                                Estado de Resultados</h3>
                            <table class="w-full border-collapse" id="preview-results-table">
                                <thead>
                                    <tr class="bg-gray-100 dark:bg-gray-800">
                                        <th class="p-3 text-left font-semibold text-sm rounded-t-lg">Concepto</th>
                                        <th class="p-3 text-left font-semibold text-sm rounded-t-lg">Monto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="2" class="p-3 text-sm">Sin datos disponibles. Calcule los
                                            resultados primero.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="mb-8">
                            <h3
                                class="text-2xl font-semibold text-light-text dark:text-dark-text pb-2 mb-4 border-b-2 border-border-light dark:border-border-dark transition-colors duration-300">
                                Ratios Financieros Clave</h3>
                            <div id="preview-ratios">
                                <p class="text-gray-500 text-sm">Sin ratios calculados.</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-4 mt-8">
                        <button
                            class="btn btn-primary bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all duration-300 flex items-center gap-2"
                            onclick="updatePreview()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="23 4 23 10 17 10"></polyline>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                            </svg>Actualizar Vista Previa
                        </button>
                    </div>
                </div>

                <!-- Pestaña de Exportar -->
                <div id="exportar" class="tab-content animate-fadeIn hidden">
                    <h2
                        class="text-2xl font-bold text-primary-600 dark:text-primary-400 border-b-2 border-primary-600 dark:border-primary-400 pb-2 mb-6 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>Exportar Reporte
                    </h2>
                    <div id="export-message"></div>

                    <div
                        class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-6 shadow-md transition-colors duration-300">
                        <h3
                            class="text-xl font-semibold text-light-text dark:text-dark-text pb-3 mb-6 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                            Personalización del Reporte</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div>
                                <!-- Nuevo diseño para subir logo, parecido a la imagen  -->
                                <label
                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Subir
                                    Logo de la Empresa</label>
                                <div id="logo-upload-container"
                                    class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-8 cursor-pointer text-center transition-colors duration-300 hover:bg-gray-100 dark:hover:bg-gray-800">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-12 w-12 text-primary-600 dark:text-primary-500 mx-auto mb-2"
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round">
                                        <path
                                            d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.92 8.35L20 18H4l-.77-.15A4 4 0 0 1 4 14.899z" />
                                        <path d="M12 12v6" />
                                        <path d="M15 15l-3 3-3-3" />
                                    </svg>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Haga clic para subir su logo
                                        (JPG, PNG, SVG)</p>
                                    <input type="file" id="company-logo" accept="image/png, image/jpeg, image/svg+xml"
                                        class="hidden">
                                </div>
                            </div>
                            <div>
                                <label
                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Nombre
                                    de la Empresa</label>
                                <input type="text" id="company-name" placeholder="Mi Empresa S.A. de C.V."
                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div>
                                <label
                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Periodo</label>
                                <input type="text" id="report-period" placeholder="Ej: Junio 2025"
                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                            </div>
                            <div>
                                <label
                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Fondo
                                    de Portada (PDF)</label>
                                <select id="cover-background"
                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                    <option value="solid">Sólido (Gradiente)</option>
                                    <option value="pattern">Patrón Suave</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div>
                                <label
                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Marca
                                    de Agua (PDF, opcional)</label>
                                <input type="text" id="watermark-text" placeholder="CONFIDENCIAL"
                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                            </div>
                            <div>
                                <label
                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Opacidad
                                    de la Marca de Agua (0.1-1.0)</label>
                                <input type="number" id="watermark-opacity" value="0.1" step="0.1" min="0.1" max="1.0"
                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-6 shadow-md transition-colors duration-300">
                        <h3
                            class="text-xl font-semibold text-light-text dark:text-dark-text pb-3 mb-6 border-b border-border-light dark:border-border-dark transition-colors duration-300">
                            Opciones de Exportación</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div>
                                <label
                                    class="block text-sm font-semibold text-light-text dark:text-dark-text mb-1">Seleccionar
                                    Sección</label>
                                <select id="export-section"
                                    class="w-full p-3 rounded-lg border border-border-light dark:border-border-dark focus:outline-none focus:ring-2 focus:ring-primary-600 bg-light-card dark:bg-gray-800 transition-colors duration-300">
                                    <option value="full">Reporte Completa</option>
                                    <option value="balance">Solo Balance General</option>
                                    <option value="results">Solo Estado de Resultados</option>
                                    <option value="ratios">Solo Ratios Financieros</option>
                                    <option value="comprobacion">Solo Comprobación</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-4 mt-8">
                        <button id="export-pdf-btn"
                            class="btn btn-primary bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all duration-300 flex items-center gap-2"
                            onclick="exportReport()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <path d="M10 15.5c.5 1.5 2.5 1.5 3 0"></path>
                                <path d="M12 18v-2"></path>
                                <path d="M10 12v-1h4v1"></path>
                                <path d="M10 9h4"></path>
                                <path d="M15 12h-1"></path>
                            </svg>Exportar PDF
                        </button>
                        <button id="export-csv-btn"
                            class="btn btn-primary bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all duration-300 flex items-center gap-2"
                            onclick="exportCSV()">
                            <svg xmlns="http://www.w3.org/2-10 0/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>Exportar CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Variables globales y estado de la aplicación ---
        let comparisonChart = null;
        let financialData = {
            balance: {},
            results: {},
            ratios: {},
            analysis: {}
        };
        let logoObjectURL = null;
        const spinnerSVG = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l1-1.647z"></path></svg>`;
        const apiKey = "";

        // --- Funciones de Utilidad y UI ---
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notification-area');
            if (!container) return;
            const notification = document.createElement('div');
            notification.className = `p-4 rounded-lg shadow-md transition-all duration-300 ease-in-out transform scale-100 ${type === 'error' ? 'bg-red-100 text-red-700 border-l-4 border-red-500 dark:bg-red-900 dark:text-red-300' :
                type === 'success' ? 'bg-green-100 text-green-700 border-l-4 border-primary-600 dark:bg-green-900 dark:text-green-300' :
                    'bg-blue-100 text-blue-700 border-l-4 border-tertiary-500 dark:bg-blue-900 dark:text-blue-300'
                }`;
            notification.textContent = message;
            container.appendChild(notification);
            setTimeout(() => {
                notification.style.transform = 'translateY(100%) scale(0.9)';
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        function showWelcomeNotification() {
            if (!sessionStorage.getItem('welcomeShown')) {
                showNotification("¡Bienvenido a Agronare Financiero! Comienza por rellenar tus datos o carga el ejemplo.", 'info', 6000);
                sessionStorage.setItem('welcomeShown', 'true');
            }
        }

        function showTabInstruction(tabId) {
            const key = `instruction_${tabId}`;
            if (sessionStorage.getItem(key)) return;

            let message = '';
            switch (tabId) {
                case 'resultados':
                    message = "Introduce tus ingresos y gastos, y luego haz clic en 'Calcular Resultados'.";
                    break;
                case 'ratios':
                    message = "Calcula el balance y los resultados primero para ver tus ratios financieros.";
                    break;
                case 'comprobacion':
                    message = "Calcula el balance y los resultados para verificar la consistencia de tus estados.";
                    break;
                case 'analisis-ia':
                    message = "Después de calcular tus datos, usa la IA para obtener análisis detallados.";
                    break;
                case 'comparativo':
                    message = "Ingresa los datos de dos periodos para compararlos visualmente.";
                    break;
                case 'vista-previa':
                    message = "Aquí puedes ver una vista previa de tu reporte final antes de exportarlo.";
                    break;
                case 'exportar':
                    message = "Personaliza y exporta tu reporte en formato PDF o CSV.";
                    break;
            }

            if (message) {
                showNotification(message, 'info');
                sessionStorage.setItem(key, 'true');
            }
        }

        function formatAsCurrency(value, showZero = false) {
            if (isNaN(value) || value === 0 && !showZero) return '';
            const formatter = new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            return formatter.format(value);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function parseCurrency(value) {
            if (typeof value !== 'string') return value || 0;
            return parseFloat(value.replace(/[^0-9.-]+/g, "")) || 0;
        }

        function getValue(id) {
            const element = document.getElementById(id);
            if (element) {
                // Remove currency symbols and commas before parsing
                const cleanValue = element.value.replace(/[^0-9.-]+/g, "");
                const num = parseFloat(cleanValue) || 0;
                element.value = num > 0 ? formatCurrency(num) : ''; // Format on blur/change
                return num;
            }
            return 0;
        }

        function getTextValue(id) {
            const element = document.getElementById(id);
            return element ? element.value.trim() : '';
        }

        function clearForm(tabId) {
            const formContainer = document.getElementById(tabId);
            if (formContainer) {
                formContainer.querySelectorAll('input[type="text"]').forEach(input => {
                    input.value = '';
                });
                formContainer.querySelectorAll('span[id^="total-"]').forEach(span => {
                    span.textContent = '';
                });
                showNotification('Campos limpiados.', 'success');
            }
        }

        // --- Core Calculation Functions ---
        function getBalanceTotals() {
            const cashTotal = getValue('cash') + getValue('banks') + getValue('short-term-investments');
            const accountsReceivableTotal = getValue('domestic-clients') + getValue('foreign-clients') + getValue('notes-receivable') - getValue('bad-debt-provision');
            const inventoryTotal = getValue('raw-materials') + getValue('work-in-progress') + getValue('finished-goods') + getValue('goods-in-transit');
            const otherCurrentAssetsTotal = getValue('tax-refunds') + getValue('interest-receivable') + getValue('supplier-advances') + getValue('other-current-assets');
            const currentAssetsTotal = cashTotal + accountsReceivableTotal + inventoryTotal + otherCurrentAssetsTotal;
            const ppeGrossTotal = getValue('land') + getValue('buildings') + getValue('machinery') + getValue('furniture') + getValue('transportation-equipment');
            const ppeNetTotal = ppeGrossTotal - getValue('accumulated-depreciation');
            const intangiblesTotal = (getValue('trademarks-patents') + getValue('licenses') + getValue('software')) - getValue('accumulated-amortization');
            const investmentsTotal = getValue('investment-shares') + getValue('bonds') + getValue('other-investments');
            const nonCurrentAssetsTotal = ppeNetTotal + intangiblesTotal + investmentsTotal;
            const totalAssets = currentAssetsTotal + nonCurrentAssetsTotal;
            const suppliersTotal = getValue('domestic-suppliers') + getValue('foreign-suppliers') + getValue('notes-payable');
            const shortTermLoansTotal = getValue('short-term-bank-loans') + getValue('bank-overdrafts');
            const taxesTotal = getValue('vat-payable') + getValue('income-tax-payable') + getValue('other-taxes');
            const otherCurrentLiabilitiesTotal = getValue('customer-advances') + getValue('provisions') + getValue('dividends-payable') + getValue('other-current-liabilities');
            const currentLiabilitiesTotal = suppliersTotal + shortTermLoansTotal + taxesTotal + otherCurrentLiabilitiesTotal;
            const longTermLiabilitiesTotal = getValue('long-term-bank-loans') + getValue('finance-lease-obligations') + getValue('other-long-term-liabilities');
            const totalLiabilities = currentLiabilitiesTotal + longTermLiabilitiesTotal;
            const totalEquity = getValue('capital-stock') + getValue('share-premium') + getValue('legal-reserves') + getValue('voluntary-reserves') + getValue('accumulated-results') + getValue('current-period-result');
            const totalLiabilitiesEquity = totalLiabilities + totalEquity;

            return {
                totalAssets,
                totalLiabilitiesEquity,
                currentAssetsTotal,
                nonCurrentAssetsTotal,
                totalLiabilities,
                totalEquity,
                cashTotal,
                accountsReceivableTotal,
                inventoryTotal,
                otherCurrentAssetsTotal,
                ppeGrossTotal,
                ppeNetTotal,
                intangiblesTotal,
                investmentsTotal,
                suppliersTotal,
                shortTermLoansTotal,
                taxesTotal,
                otherCurrentLiabilitiesTotal,
                currentLiabilitiesTotal,
                longTermLiabilitiesTotal
            };
        }

        function validateAccountingEquation() {
            const {
                totalAssets,
                totalLiabilitiesEquity
            } = getBalanceTotals();
            const difference = Math.abs(totalAssets - totalLiabilitiesEquity);
            if (difference > 0.01) {
                showNotification(`¡Descuadre en la ecuación contable! Activo (${formatCurrency(totalAssets)}) ≠ Pasivo + Patrimonio (${formatCurrency(totalLiabilitiesEquity)})`, 'error');
                return false;
            }
            return true;
        }

        function calculateBalance() {
            const totals = getBalanceTotals();
            financialData.balance = {
                cash: {
                    cash: getValue('cash'),
                    banks: getValue('banks'),
                    shortTermInvestments: getValue('short-term-investments')
                },
                accountsReceivable: {
                    domesticClients: getValue('domestic-clients'),
                    foreignClients: getValue('foreign-clients'),
                    notesReceivable: getValue('notes-receivable'),
                    badDebtProvision: getValue('bad-debt-provision')
                },
                inventory: {
                    rawMaterials: getValue('raw-materials'),
                    workInProgress: getValue('work-in-progress'),
                    finishedGoods: getValue('finished-goods'),
                    goodsInTransit: getValue('goods-in-transit')
                },
                otherCurrentAssets: {
                    taxRefunds: getValue('tax-refunds'),
                    interestReceivable: getValue('interest-receivable'),
                    supplierAdvances: getValue('supplier-advances'),
                    other: getValue('other-current-assets')
                },
                ppe: {
                    land: getValue('land'),
                    buildings: getValue('buildings'),
                    machinery: getValue('machinery'),
                    furniture: getValue('furniture'),
                    transportationEquipment: getValue('transportation-equipment'),
                    accumulatedDepreciation: getValue('accumulated-depreciation')
                },
                intangibles: {
                    trademarksPatents: getValue('trademarks-patents'),
                    licenses: getValue('licenses'),
                    software: getValue('software'),
                    accumulatedAmortization: getValue('accumulated-amortization')
                },
                investments: {
                    investmentShares: getValue('investment-shares'),
                    bonds: getValue('bonds'),
                    other: getValue('other-investments')
                },
                suppliers: {
                    domesticSuppliers: getValue('domestic-suppliers'),
                    foreignSuppliers: getValue('foreign-suppliers'),
                    notesPayable: getValue('notes-payable')
                },
                shortTermLoans: {
                    bankLoans: getValue('short-term-bank-loans'),
                    overdrafts: getValue('bank-overdrafts')
                },
                taxes: {
                    vatPayable: getValue('vat-payable'),
                    incomeTaxPayable: getValue('income-tax-payable'),
                    otherTaxes: getValue('other-taxes')
                },
                otherCurrentLiabilities: {
                    customerAdvances: getValue('customer-advances'),
                    provisions: getValue('provisions'),
                    dividendsPayable: getValue('dividends-payable'),
                    other: getValue('other-current-liabilities')
                },
                longTermLiabilities: {
                    bankLoans: getValue('long-term-bank-loans'),
                    financeLease: getValue('finance-lease-obligations'),
                    other: getValue('other-long-term-liabilities')
                },
                equity: {
                    capitalStock: getValue('capital-stock'),
                    sharePremium: getValue('share-premium'),
                    legalReserves: getValue('legal-reserves'),
                    voluntaryReserves: getValue('voluntary-reserves'),
                    accumulatedResults: getValue('accumulated-results'),
                    currentPeriodResult: getValue('current-period-result')
                },
                totals: totals
            };

            // Actualizar totales en la UI
            document.getElementById('total-cash').textContent = formatCurrency(totals.cashTotal);
            document.getElementById('total-accounts-receivable').textContent = formatCurrency(totals.accountsReceivableTotal);
            document.getElementById('total-inventory').textContent = formatCurrency(totals.inventoryTotal);
            document.getElementById('total-other-current-assets').textContent = formatCurrency(totals.otherCurrentAssetsTotal);
            document.getElementById('total-ppe-net').textContent = formatCurrency(totals.ppeNetTotal);
            document.getElementById('total-intangibles').textContent = formatCurrency(totals.intangiblesTotal);
            document.getElementById('total-investments').textContent = formatCurrency(totals.investmentsTotal);

            document.getElementById('total-suppliers').textContent = formatCurrency(totals.suppliersTotal);
            document.getElementById('total-short-term-loans').textContent = formatCurrency(totals.shortTermLoansTotal);
            document.getElementById('total-taxes').textContent = formatCurrency(totals.taxesTotal);
            document.getElementById('total-other-current-liabilities').textContent = formatCurrency(totals.otherCurrentLiabilitiesTotal);
            document.getElementById('total-long-term-liabilities').textContent = formatCurrency(totals.longTermLiabilitiesTotal);
            document.getElementById('total-equity').textContent = formatCurrency(totals.totalEquity);

            showNotification('Balance General calculado correctamente.', 'success');
        }

        function getResultsTotals() {
            const grossSales = getValue('gross-sales');
            const salesReturns = getValue('sales-returns');
            const salesDiscounts = getValue('sales-discounts');
            const bonuses = getValue('bonuses');
            const netSales = grossSales - salesReturns - salesDiscounts - bonuses;

            const totalOtherIncome = getValue('rental-income') + getValue('financial-income') + getValue('asset-sale-gain') + getValue('other-income');
            const totalRevenue = netSales + totalOtherIncome;

            const costOfSales = (getValue('beginning-inventory') + getValue('net-purchases') - getValue('ending-inventory')) + getValue('finished-goods-cost');
            const grossProfit = totalRevenue - costOfSales;

            const totalSalesExpenses = getValue('sales-salaries') + getValue('sales-commissions') + getValue('advertising') + getValue('freight-out') + getValue('other-sales-expenses');
            const totalAdminExpenses = getValue('admin-salaries') + getValue('professional-fees') + getValue('general-services') + getValue('office-maintenance') + getValue('depreciation-expense') + getValue('amortization-expense') + getValue('other-admin-expenses');
            const totalOperatingExpenses = totalSalesExpenses + totalAdminExpenses;
            const operatingProfit = grossProfit - totalOperatingExpenses;

            const totalFinancialExpenses = getValue('interest-expense') + getValue('bank-commissions') + getValue('exchange-loss') + getValue('other-financial-expenses');
            const profitBeforeTax = operatingProfit - totalFinancialExpenses;

            const totalTaxes = getValue('income-tax') + getValue('other-taxes-expense');
            const netIncome = profitBeforeTax - totalTaxes;

            return {
                netSales,
                totalOtherIncome,
                totalRevenue,
                costOfSales,
                grossProfit,
                totalSalesExpenses,
                totalAdminExpenses,
                totalOperatingExpenses,
                operatingProfit,
                totalFinancialExpenses,
                profitBeforeTax,
                totalTaxes,
                netIncome
            };
        }

        function calculateResults() {
            const totals = getResultsTotals();
            financialData.results = {
                revenue: {
                    grossSales: getValue('gross-sales'),
                    salesReturns: getValue('sales-returns'),
                    salesDiscounts: getValue('sales-discounts'),
                    bonuses: getValue('bonuses'),
                    netSales: totals.netSales,
                    rentalIncome: getValue('rental-income'),
                    financialIncome: getValue('financial-income'),
                    assetSaleGain: getValue('asset-sale-gain'),
                    otherIncome: getValue('other-income'),
                    totalOtherIncome: totals.totalOtherIncome,
                    totalRevenue: totals.totalRevenue
                },
                costOfSales: {
                    beginningInventory: getValue('beginning-inventory'),
                    netPurchases: getValue('net-purchases'),
                    endingInventory: getValue('ending-inventory'),
                    finishedGoodsCost: getValue('finished-goods-cost'),
                    costOfSales: totals.costOfSales
                },
                operatingExpenses: {
                    sales: {
                        salaries: getValue('sales-salaries'),
                        commissions: getValue('sales-commissions'),
                        advertising: getValue('advertising'),
                        freightOut: getValue('freight-out'),
                        other: getValue('other-sales-expenses'),
                        total: totals.totalSalesExpenses
                    },
                    administration: {
                        salaries: getValue('admin-salaries'),
                        professionalFees: getValue('professional-fees'),
                        generalServices: getValue('general-services'),
                        officeMaintenance: getValue('office-maintenance'),
                        depreciation: getValue('depreciation-expense'),
                        amortization: getValue('amortization-expense'),
                        other: getValue('other-admin-expenses'),
                        total: totals.totalAdminExpenses
                    },
                    totalOperatingExpenses: totals.totalOperatingExpenses
                },
                financialExpenses: {
                    interest: getValue('interest-expense'),
                    bankCommissions: getValue('bank-commissions'),
                    exchangeLoss: getValue('exchange-loss'),
                    other: getValue('other-financial-expenses'),
                    total: totals.totalFinancialExpenses
                },
                taxes: {
                    incomeTax: getValue('income-tax'),
                    otherTaxes: getValue('other-taxes-expense'),
                    total: totals.totalTaxes
                },
                netIncome: totals.netIncome,
                totals: totals
            };

            // Actualizar totales en la UI
            document.getElementById('total-net-sales').textContent = formatCurrency(totals.netSales);
            document.getElementById('total-other-income').textContent = formatCurrency(totals.totalOtherIncome);
            document.getElementById('total-cost-of-sales').textContent = formatCurrency(totals.costOfSales);
            document.getElementById('total-sales-expenses').textContent = formatCurrency(totals.totalSalesExpenses);
            document.getElementById('total-admin-expenses').textContent = formatCurrency(totals.totalAdminExpenses);
            document.getElementById('total-financial-expenses').textContent = formatCurrency(totals.totalFinancialExpenses);
            document.getElementById('total-taxes-expense').textContent = formatCurrency(totals.totalTaxes);

            showNotification(`Estado de Resultados calculado. Utilidad Neta: ${formatCurrency(totals.netIncome)}`, 'success');
        }

        function calculateRatios() {
            if (!financialData.balance.totals || !financialData.results.totals) {
                showNotification('Primero calcule el Balance General y el Estado de Resultados.', 'error');
                return;
            }

            const {
                currentAssetsTotal,
                totalAssets,
                currentLiabilitiesTotal,
                totalLiabilities,
                totalEquity,
                inventoryTotal
            } = financialData.balance.totals;
            const {
                netIncome,
                totalRevenue,
                grossProfit
            } = financialData.results.totals;

            const ratios = {
                currentRatio: currentLiabilitiesTotal > 0 ? currentAssetsTotal / currentLiabilitiesTotal : 0,
                quickRatio: currentLiabilitiesTotal > 0 ? (currentAssetsTotal - inventoryTotal) / currentLiabilitiesTotal : 0,
                debtRatio: totalAssets > 0 ? totalLiabilities / totalAssets : 0,
                equityRatio: totalAssets > 0 ? totalEquity / totalAssets : 0,
                roe: totalEquity > 0 ? netIncome / totalEquity : 0,
                netMargin: totalRevenue > 0 ? netIncome / totalRevenue : 0,
                grossMargin: totalRevenue > 0 ? grossProfit / totalRevenue : 0
            };

            financialData.ratios = ratios;
            displayRatios(ratios);
            showNotification('Ratios Financieros calculados correctamente.', 'success');
        }

        function checkFinancialStatements() {
            if (!financialData.balance.totals || !financialData.results.totals) {
                showNotification('Primero calcule el Balance General y el Estado de Resultados.', 'error');
                return;
            }

            const resultsDiv = document.getElementById('comprobacion-results');
            resultsDiv.innerHTML = '';

            const { totalAssets, totalLiabilitiesEquity, totalEquity } = financialData.balance.totals;
            const { netIncome } = financialData.results.totals;

            let isBalanced = true;

            // Comprobación de la Ecuación Contable
            const accountingEquationCheck = Math.abs(totalAssets - totalLiabilitiesEquity) < 0.01;
            const accountingMessage = document.createElement('div');
            accountingMessage.className = `p-4 rounded-lg flex items-center gap-3 ${accountingEquationCheck ? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300' : 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300'}`;
            accountingMessage.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${accountingEquationCheck ? 'text-green-500' : 'text-red-500'}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="${accountingEquationCheck ? 'M5 13l4 4L19 7' : 'M6 18L18 6M6 6l12 12'}" />
                </svg>
                <div>
                    <h4 class="font-bold">Ecuación Contable (Activo = Pasivo + Patrimonio)</h4>
                    <p class="text-sm">Resultado: ${accountingEquationCheck ? '¡Los estados cuadran!' : '¡Los estados no cuadran!'}</p>
                    <p class="text-sm">Activo: ${formatCurrency(totalAssets)}</p>
                    <p class="text-sm">Pasivo + Patrimonio: ${formatCurrency(totalLiabilitiesEquity)}</p>
                </div>
            `;
            resultsDiv.appendChild(accountingMessage);
            if (!accountingEquationCheck) isBalanced = false;

            // Comprobación de Utilidad Neta
            const netIncomeCheck = Math.abs(netIncome - getValue('current-period-result')) < 0.01;
            const netIncomeMessage = document.createElement('div');
            netIncomeMessage.className = `p-4 rounded-lg flex items-center gap-3 ${netIncomeCheck ? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300' : 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300'}`;
            netIncomeMessage.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${netIncomeCheck ? 'text-green-500' : 'text-red-500'}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="${netIncomeCheck ? 'M5 13l4 4L19 7' : 'M6 18L18 6M6 6l12 12'}" />
                </svg>
                <div>
                    <h4 class="font-bold">Conciliación del Resultado del Ejercicio</h4>
                    <p class="text-sm">Resultado: ${netIncomeCheck ? '¡La utilidad neta coincide!' : '¡La utilidad neta no coincide!'}</p>
                    <p class="text-sm">Utilidad Neta (Estado de Resultados): ${formatCurrency(netIncome)}</p>
                    <p class="text-sm">Resultado del Ejercicio (Balance): ${formatCurrency(getValue('current-period-result'))}</p>
                </div>
            `;
            resultsDiv.appendChild(netIncomeMessage);
            if (!netIncomeCheck) isBalanced = false;

            if (isBalanced) {
                showNotification('¡La comprobación ha sido exitosa! Tus estados financieros son consistentes.', 'success', 8000);
            } else {
                showNotification('La comprobación ha fallado. Revisa los detalles en la sección de Comprobación de Estados.', 'error', 8000);
            }
        }

        function displayRatios(ratios) {
            const mode = document.getElementById('ratio-mode').value;
            const container = document.getElementById('ratios-display');
            const {
                netIncome
            } = financialData.results.totals;

            const bankModeHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg shadow-sm border-l-4 border-blue-500">
                    <h4 class="text-sm font-bold text-blue-700 dark:text-blue-300">Razón Corriente</h4>
                    <p class="text-2xl font-bold mt-2">${ratios.currentRatio.toFixed(2)}</p>
                    <small class="text-gray-500 dark:text-gray-400">Activo Corriente / Pasivo Corriente</small>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg shadow-sm border-l-4 border-blue-500">
                    <h4 class="text-sm font-bold text-blue-700 dark:text-blue-300">Prueba Ácida</h4>
                    <p class="text-2xl font-bold mt-2">${ratios.quickRatio.toFixed(2)}</p>
                    <small class="text-gray-500 dark:text-gray-400">(Act. Corr. - Inventarios) / Pas. Corr.</small>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg shadow-sm border-l-4 border-blue-500">
                    <h4 class="text-sm font-bold text-blue-700 dark:text-blue-300">Ratio de Endeudamiento</h4>
                    <p class="text-2xl font-bold mt-2">${(ratios.debtRatio * 100).toFixed(1)}%</p>
                    <small class="text-gray-500 dark:text-gray-400">Pasivo Total / Activo Total</small>
                </div>
            </div>`;

            const investorModeHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg shadow-sm border-l-4 border-green-500">
                    <h4 class="text-sm font-bold text-green-700 dark:text-green-300">ROE</h4>
                    <p class="text-2xl font-bold mt-2">${(ratios.roe * 100).toFixed(2)}%</p>
                    <small class="text-gray-500 dark:text-gray-400">Utilidad Neta / Patrimonio</small>
                </div>
                <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg shadow-sm border-l-4 border-green-500">
                    <h4 class="text-sm font-bold text-green-700 dark:text-green-300">Margen Neto</h4>
                    <p class="text-2xl font-bold mt-2">${(ratios.netMargin * 100).toFixed(2)}%</p>
                    <small class="text-gray-500 dark:text-gray-400">Utilidad Neta / Ventas</small>
                </div>
                <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg shadow-sm border-l-4 border-green-500">
                    <h4 class="text-sm font-bold text-green-700 dark:text-green-300">Utilidad Neta</h4>
                    <p class="text-2xl font-bold mt-2">${formatCurrency(netIncome)}</p>
                    <small class="text-gray-500 dark:text-gray-400">Ingresos - Gastos</small>
                </div>
            </div>`;
            container.innerHTML = mode === 'bank' ? bankModeHTML : investorModeHTML;
        }

        function switchRatioMode() {
            if (financialData.ratios && Object.keys(financialData.ratios).length > 0) {
                displayRatios(financialData.ratios);
            }
        }

        function generateComparison() {
            const period1Name = getTextValue('period1-name') || 'Periodo 1';
            const period2Name = getTextValue('period2-name') || 'Periodo 2';
            const period1NetIncome = getValue('period1-net-income');
            const period2NetIncome = getValue('period2-net-income');
            const period1Sales = getValue('period1-sales');
            const period2Sales = getValue('period2-sales');
            const incomeVariation = period1NetIncome !== 0 ? ((period2NetIncome - period1NetIncome) / Math.abs(period1NetIncome)) * 100 : 0;
            const ctx = document.getElementById('comparison-chart').getContext('2d');

            if (comparisonChart) comparisonChart.destroy();

            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [period1Name, period2Name],
                    datasets: [
                        {
                            label: 'Utilidad Neta',
                            data: [period1NetIncome, period2NetIncome],
                            backgroundColor: ['#4ADE80', '#16A34A']
                        },
                        {
                            label: 'Ventas Netas',
                            data: [period1Sales, period2Sales],
                            backgroundColor: ['#86EFAC', '#4ADE80']
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Comparativo de Periodos'
                        }
                    }
                }
            });

            showNotification(`Comparativo generado. Variación en Utilidad: ${incomeVariation >= 0 ? '+' : ''}${incomeVariation.toFixed(1)}%`, 'success');
        }

        function generateBalanceTablesHtml(balanceData, isPDF = false) {
            const bt = balanceData.totals;
            const tableClass = isPDF ? 'pdf-table' : 'w-full border-collapse';
            const thClass = isPDF ? 'pdf-th' : 'p-3 text-left font-semibold text-sm rounded-t-lg';
            const tdClass = isPDF ? 'pdf-td' : 'p-3 text-sm';
            const highlightRowClass = isPDF ? 'highlight-row' : 'bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-300 font-semibold';
            const totalRowClass = isPDF ? 'total-row' : 'bg-primary-600 text-white dark:bg-primary-500 font-bold';

            const activosHtml = `
            <table class="${tableClass}">
                <thead><tr class="bg-gray-100 dark:bg-gray-800"><th class="${thClass}">Concepto</th><th class="${thClass}">Monto</th></tr></thead>
                <tbody>
                    <tr class="bg-gray-50 dark:bg-gray-700"><td colspan="2" class="${tdClass} font-bold">ACTIVO</td></tr>
                    <tr class="bg-gray-100 dark:bg-gray-600"><td class="${tdClass} font-semibold">Activo Corriente</td><td></td></tr>
                    <tr><td class="${tdClass}">&nbsp;&nbsp;Disponibilidades</td><td class="${tdClass}">${formatCurrency(bt.cashTotal)}</td></tr>
                    <tr><td class="${tdClass}">&nbsp;&nbsp;Cuentas por Cobrar Comerciales</td><td class="${tdClass}">${formatCurrency(bt.accountsReceivableTotal)}</td></tr>
                    <tr><td class="${tdClass}">&nbsp;&nbsp;Inventarios</td><td class="${tdClass}">${formatCurrency(bt.inventoryTotal)}</td></tr>
                    <tr><td class="${tdClass}">&nbsp;&nbsp;Otros Activos Corrientes</td><td class="${tdClass}">${formatCurrency(bt.otherCurrentAssetsTotal)}</td></tr>
                    <tr class="${highlightRowClass}"><td class="${tdClass}">Total Activo Corriente</td><td class="${tdClass}">${formatCurrency(bt.currentAssetsTotal)}</td></tr>
                    <tr class="bg-gray-100 dark:bg-gray-600"><td class="${tdClass} font-semibold">Activo No Corriente</td><td></td></tr>
                    <tr><td class="${tdClass}">&nbsp;&nbsp;Propiedad, Planta y Equipo (Neto)</td><td class="${tdClass}">${formatCurrency(bt.ppeNetTotal)}</td></tr>
                    <tr><td class="${tdClass}">&nbsp;&nbsp;Intangibles (Neto)</td><td class="${tdClass}">${formatCurrency(bt.intangiblesTotal)}</td></tr>
                    <tr><td class="${tdClass}">&nbsp;&nbsp;Inversiones Permanentes</td><td class="${tdClass}">${formatCurrency(bt.investmentsTotal)}</td></tr>
                    <tr class="${highlightRowClass}"><td class="${tdClass}">Total Activo No Corriente</td><td class="${tdClass}">${formatCurrency(bt.nonCurrentAssetsTotal)}</td></tr>
                    <tr class="${totalRowClass}"><td class="${tdClass}">TOTAL ACTIVO</td><td class="${tdClass}"><strong>${formatCurrency(bt.totalAssets)}</strong></td></tr>
                </tbody>
            </table>`;

            const pasivosHtml = `
            <table class="${tableClass}">
                <thead><tr class="bg-gray-100 dark:bg-gray-800"><th class="${thClass}">Concepto</th><th class="${thClass}">Monto</th></tr></thead>
                <tbody>
                    <tr class="bg-gray-50 dark:bg-gray-700"><td colspan="2" class="${tdClass} font-bold">PASIVO Y PATRIMONIO</td></tr>
                    <tr class="bg-gray-100 dark:bg-gray-600"><td class="${tdClass} font-semibold">Pasivo Corriente</td><td></td></tr>
                    <tr><td class="${tdClass}">&nbsp;&nbsp;Proveedores</td><td class="${tdClass}">${formatCurrency(bt.suppliersTotal)}</td></tr>
                    <tr><td class="${tdClass}">&nbsp;&nbsp;Obligaciones Financieras</td><td class="${tdClass}">${formatCurrency(bt.shortTermLoansTotal)}</td></tr>
                    <tr><td class="${tdClass}">&nbsp;&nbsp;Obligaciones Fiscales</td><td class="${tdClass}">${formatCurrency(bt.taxesTotal)}</td></tr>
                    <tr><td class="${tdClass}">&nbsp;&nbsp;Otros Pasivos Corrientes</td><td class="${tdClass}">${formatCurrency(bt.otherCurrentLiabilitiesTotal)}</td></tr>
                    <tr class="${highlightRowClass}"><td class="${tdClass}">Total Pasivo Corriente</td><td class="${tdClass}">${formatCurrency(bt.currentLiabilitiesTotal)}</td></tr>
                    <tr class="bg-gray-100 dark:bg-gray-600"><td class="${tdClass} font-semibold">Pasivo No Corriente</td><td></td></tr>
                    <tr><td class="${tdClass}">&nbsp;&nbsp;Deuda a Largo Plazo</td><td class="${tdClass}">${formatCurrency(bt.longTermLiabilitiesTotal)}</td></tr>
                    <tr class="${highlightRowClass}"><td class="${tdClass}">Total Pasivo No Corriente</td><td class="${tdClass}">${formatCurrency(bt.longTermLiabilitiesTotal)}</td></tr>
                    <tr class="bg-tertiary-100 dark:bg-tertiary-900 text-tertiary-800 dark:text-tertiary-300 font-semibold"><td class="${tdClass}">Total Pasivo</td><td class="${tdClass}">${formatCurrency(bt.totalLiabilities)}</td></tr>
                    <tr class="bg-gray-100 dark:bg-gray-600"><td class="${tdClass} font-semibold">Patrimonio</td><td></td></tr>
                    <tr><td class="${tdClass}">&nbsp;&nbsp;Capital Social y Reservas</td><td class="${tdClass}">${formatCurrency(bt.totalEquity - getValue('current-period-result'))}</td></tr>
                    <tr><td class="${tdClass}">&nbsp;&nbsp;Resultado del Ejercicio</td><td class="${tdClass}">${formatCurrency(getValue('current-period-result'))}</td></tr>
                    <tr class="${highlightRowClass}"><td class="${tdClass}">Total Patrimonio</td><td class="${tdClass}">${formatCurrency(bt.totalEquity)}</td></tr>
                    <tr class="${totalRowClass}"><td class="${tdClass}">TOTAL PASIVO Y PATRIMONIO</td><td class="${tdClass}"><strong>${formatCurrency(bt.totalLiabilitiesEquity)}</strong></td></tr>
                </tbody>
            </table>`;
            return {
                activosHtml,
                pasivosHtml
            };
        }

        function generateResultsTableHtml(resultsData, isPDF = false) {
            const rt = resultsData.totals;
            const tableClass = isPDF ? 'pdf-table' : 'w-full border-collapse';
            const thClass = isPDF ? 'pdf-th' : 'p-3 text-left font-semibold text-sm rounded-t-lg';
            const tdClass = isPDF ? 'pdf-td' : 'p-3 text-sm';
            const highlightRowClass = isPDF ? 'highlight-row' : 'bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-300 font-semibold';
            const totalRowClass = isPDF ? 'total-row' : 'bg-primary-600 text-white dark:bg-primary-500 font-bold';

            return `
            <table class="${tableClass}">
                <thead>
                    <tr class="bg-gray-100 dark:bg-gray-800">
                        <th class="${thClass}">Concepto</th>
                        <th class="${thClass}">Monto</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="${highlightRowClass}"><td class="${tdClass}">Total Ventas Netas</td><td class="${tdClass}"><strong>${formatCurrency(rt.netSales)}</strong></td></tr>
                    <tr class="${highlightRowClass}"><td class="${tdClass}">Total Otros Ingresos</td><td class="${tdClass}"><strong>${formatCurrency(rt.totalOtherIncome)}</strong></td></tr>
                    <tr class="${totalRowClass}"><td class="${tdClass}">TOTAL INGRESOS</td><td class="${tdClass}"><strong>${formatCurrency(rt.totalRevenue)}</strong></td></tr>
                    <tr class="${highlightRowClass}"><td class="${tdClass}">Total Costo de Ventas</td><td class="${tdClass}"><strong>(${formatCurrency(rt.costOfSales)})</strong></td></tr>
                    <tr class="${totalRowClass}"><td class="${tdClass}">UTILIDAD BRUTA</td><td class="${tdClass}"><strong>${formatCurrency(rt.grossProfit)}</strong></td></tr>
                    <tr class="${highlightRowClass}"><td class="${tdClass}">Total Gastos de Venta</td><td class="${tdClass}">(${formatCurrency(rt.totalSalesExpenses)})</td></tr>
                    <tr class="${highlightRowClass}"><td class="${tdClass}">Total Gastos de Administración</td><td class="${tdClass}">(${formatCurrency(rt.totalAdminExpenses)})</td></tr>
                    <tr class="${totalRowClass}"><td class="${tdClass}">TOTAL GASTOS DE OPERACIÓN</td><td class="${tdClass}"><strong>(${formatCurrency(rt.totalOperatingExpenses)})</strong></td></tr>
                    <tr class="${totalRowClass}"><td class="${tdClass}">UTILIDAD OPERATIVA</td><td class="${tdClass}"><strong>${formatCurrency(rt.operatingProfit)}</strong></td></tr>
                    <tr class="${highlightRowClass}"><td class="${tdClass}">Total Gastos Financieros</td><td class="${tdClass}">(${formatCurrency(rt.totalFinancialExpenses)})</td></tr>
                    <tr class="${totalRowClass}"><td class="${tdClass}">UTILIDAD ANTES DE IMPUESTOS</td><td class="${tdClass}"><strong>${formatCurrency(rt.profitBeforeTax)}</strong></td></tr>
                    <tr class="${highlightRowClass}"><td class="${tdClass}">Total Impuestos</td><td class="${tdClass}">(${formatCurrency(rt.totalTaxes)})</td></tr>
                    <tr class="${totalRowClass} bg-secondary-500"><td class="${tdClass} font-bold text-lg">UTILIDAD NETA</td><td class="${tdClass} font-bold text-lg"><strong>${formatCurrency(rt.netIncome)}</strong></td></tr>
                </tbody>
            </table>`;
        }

        function updatePreviewTables() {
            const balanceContentDiv = document.getElementById('preview-balance-content');
            if (financialData.balance.totals) {
                const {
                    activosHtml,
                    pasivosHtml
                } = generateBalanceTablesHtml(financialData.balance);
                balanceContentDiv.innerHTML = `<div class="flex-1">${activosHtml}</div><div class="flex-1">${pasivosHtml}</div>`;
            } else {
                balanceContentDiv.innerHTML = `<table class="w-full border-collapse" id="preview-balance-table"><thead><tr class="bg-gray-100 dark:bg-gray-800"><th class="p-3 text-left font-semibold text-sm rounded-t-lg">Concepto</th><th class="p-3 text-left font-semibold text-sm rounded-t-lg">Monto</th></tr></thead><tbody><tr><td colspan="2" class="p-3 text-sm">Sin datos disponibles. Calcule el balance primero.</td></tr></tbody></table>`;
            }

            if (financialData.results.totals) {
                document.getElementById('preview-results-table').innerHTML = generateResultsTableHtml(financialData.results);
            }

            if (financialData.ratios && Object.keys(financialData.ratios).length > 0) {
                const ratios = financialData.ratios;
                document.getElementById('preview-ratios').innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="bg-light-card dark:bg-dark-card p-4 rounded-lg border-l-4 border-primary-600 dark:border-primary-500 shadow-sm"><h4 class="text-xs font-semibold text-gray-500 dark:text-gray-400">Razón Corriente</h4><p class="text-xl font-bold">${ratios.currentRatio.toFixed(2)}</p></div>
                    <div class="bg-light-card dark:bg-dark-card p-4 rounded-lg border-l-4 border-primary-600 dark:border-primary-500 shadow-sm"><h4 class="text-xs font-semibold text-gray-500 dark:text-gray-400">ROE</h4><p class="text-xl font-bold">${(ratios.roe * 100).toFixed(2)}%</p></div>
                    <div class="bg-light-card dark:bg-dark-card p-4 rounded-lg border-l-4 border-primary-600 dark:border-primary-500 shadow-sm"><h4 class="text-xs font-semibold text-gray-500 dark:text-gray-400">Margen Neto</h4><p class="text-xl font-bold">${(ratios.netMargin * 100).toFixed(2)}%</p></div>
                </div>`;
            }
        }

        function getPdfContent() {
            const section = document.getElementById('export-section').value;
            const pdfContainer = document.createElement('div');
            pdfContainer.className = 'pdf-report';

            if (logoObjectURL) {
                const watermarkImage = document.createElement('img');
                watermarkImage.src = logoObjectURL;
                watermarkImage.className = 'pdf-watermark-image';
                watermarkImage.style.opacity = document.getElementById('watermark-opacity').value;
                pdfContainer.appendChild(watermarkImage);
            }

            const contentDiv = document.createElement('div');
            contentDiv.className = 'pdf-content-with-watermark';

            const companyName = getTextValue('company-name') || 'Nombre de la Empresa';
            const reportPeriod = getTextValue('report-period') || 'YYYY-MM';
            const titleHtml = `<div class="text-center mb-8 pb-8 border-b-2 border-border-light dark:border-border-dark"><h2 class="text-3xl font-bold text-primary-600 dark:text-primary-500 mb-2">${companyName}</h2><p class="text-lg text-gray-500 dark:text-gray-400">Periodo: ${reportPeriod}</p></div>`;
            contentDiv.innerHTML += titleHtml;

            if (financialData.analysis.summary) {
                contentDiv.innerHTML += `<div class="ai-analysis-container bg-primary-50 dark:bg-primary-900 border border-primary-200 dark:border-primary-800 p-6 rounded-xl mt-8 mb-8"><h4 class="text-lg font-semibold text-primary-600 dark:text-primary-500">✨ Resumen Ejecutivo por IA</h4><p class="mt-2 text-sm leading-relaxed">${financialData.analysis.summary.replace(/\n/g, '<br>')}</p></div>`;
            }

            if (section === 'full' || section === 'balance') {
                if (financialData.balance.totals) {
                    const {
                        activosHtml,
                        pasivosHtml
                    } = generateBalanceTablesHtml(financialData.balance, true);
                    const balanceSection = `<div class="mb-8"><h3 class="text-2xl font-semibold pb-2 mb-4 border-b-2">Balance General</h3><div class="flex flex-col md:flex-row gap-4"><div class="flex-1">${activosHtml}</div><div class="flex-1">${pasivosHtml}</div></div></div>`;
                    contentDiv.innerHTML += balanceSection;
                }
            }

            if (section === 'full' || section === 'results') {
                if (financialData.results.totals) {
                    const resultsSection = `<div class="mb-8"><h3 class="text-2xl font-semibold pb-2 mb-4 border-b-2">Estado de Resultados</h3>${generateResultsTableHtml(financialData.results, true)}</div>`;
                    contentDiv.innerHTML += resultsSection;
                }
            }

            if (section === 'full' || section === 'ratios') {
                if (financialData.ratios && Object.keys(financialData.ratios).length > 0) {
                    const ratios = financialData.ratios;
                    const ratiosSection = `<div class="mb-8"><h3 class="text-2xl font-semibold pb-2 mb-4 border-b-2">Ratios Financieros Clave</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"><div class="bg-gray-100 p-4 rounded-lg border-l-4 border-primary-600 shadow-sm"><h4 class="text-xs font-semibold text-gray-500">Razón Corriente</h4><p class="text-xl font-bold">${ratios.currentRatio.toFixed(2)}</p></div><div class="bg-gray-100 p-4 rounded-lg border-l-4 border-primary-600 shadow-sm"><h4 class="text-xs font-semibold text-gray-500">ROE</h4><p class="text-xl font-bold">${(ratios.roe * 100).toFixed(2)}%</p></div><div class="bg-gray-100 p-4 rounded-lg border-l-4 border-primary-600 shadow-sm"><h4 class="text-xs font-semibold text-gray-500">Margen Neto</h4><p class="text-xl font-bold">${(ratios.netMargin * 100).toFixed(2)}%</p></div></div></div>`;
                    contentDiv.innerHTML += ratiosSection;
                }
            }
            if (section === 'full' || section === 'comprobacion') {
                const comprobacionSection = `
                    <div class="mb-8">
                        <h3 class="text-2xl font-semibold pb-2 mb-4 border-b-2">Comprobación de Estados</h3>
                        <div id="comprobacion-results-pdf" class="space-y-4"></div>
                    </div>
                `;
                contentDiv.innerHTML += comprobacionSection;
                const comprobacionResultsDiv = contentDiv.querySelector('#comprobacion-results-pdf');
                if (financialData.balance.totals && financialData.results.totals) {
                    const { totalAssets, totalLiabilitiesEquity, totalEquity } = financialData.balance.totals;
                    const { netIncome } = financialData.results.totals;
                    const accountingEquationCheck = Math.abs(totalAssets - totalLiabilitiesEquity) < 0.01;
                    const netIncomeCheck = Math.abs(netIncome - getValue('current-period-result')) < 0.01;

                    const accountingMessage = document.createElement('div');
                    accountingMessage.className = `p-4 rounded-lg flex items-center gap-3 ${accountingEquationCheck ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
                    accountingMessage.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${accountingEquationCheck ? 'text-green-500' : 'text-red-500'}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="${accountingEquationCheck ? 'M5 13l4 4L19 7' : 'M6 18L18 6M6 6l12 12'}" />
                        </svg>
                        <div>
                            <h4 class="font-bold">Ecuación Contable (Activo = Pasivo + Patrimonio)</h4>
                            <p class="text-sm">Resultado: ${accountingEquationCheck ? '¡Los estados cuadran!' : '¡Los estados no cuadran!'}</p>
                            <p class="text-sm">Activo: ${formatCurrency(totalAssets)}</p>
                            <p class="text-sm">Pasivo + Patrimonio: ${formatCurrency(totalLiabilitiesEquity)}</p>
                        </div>
                    `;
                    comprobacionResultsDiv.appendChild(accountingMessage);

                    const netIncomeMessage = document.createElement('div');
                    netIncomeMessage.className = `p-4 rounded-lg flex items-center gap-3 ${netIncomeCheck ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
                    netIncomeMessage.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${netIncomeCheck ? 'text-green-500' : 'text-red-500'}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="${netIncomeCheck ? 'M5 13l4 4L19 7' : 'M6 18L18 6M6 6l12 12'}" />
                        </svg>
                        <div>
                            <h4 class="font-bold">Conciliación del Resultado del Ejercicio</h4>
                            <p class="text-sm">Resultado: ${netIncomeCheck ? '¡La utilidad neta coincide!' : '¡La utilidad neta no coincide!'}</p>
                            <p class="text-sm">Utilidad Neta (Estado de Resultados): ${formatCurrency(netIncome)}</p>
                            <p class="text-sm">Resultado del Ejercicio (Balance): ${formatCurrency(getValue('current-period-result'))}</p>
                        </div>
                    `;
                    comprobacionResultsDiv.appendChild(netIncomeMessage);

                } else {
                    comprobacionResultsDiv.innerHTML = `<p class="text-gray-500 text-sm">Sin datos para comprobar. Calcula el balance y los resultados primero.</p>`;
                }
            }


            pdfContainer.appendChild(contentDiv);
            return pdfContainer;
        }

        async function exportReport() {
            const companyName = getTextValue('company-name') || 'Reporte Financiero';
            const reportPeriod = getTextValue('report-period') || 'N/A';
            const logoUrl = logoObjectURL;
            const watermarkText = getTextValue('watermark-text');
            const watermarkOpacity = parseFloat(document.getElementById('watermark-opacity').value);
            const exportBtn = document.getElementById('export-pdf-btn');
            const originalBtnHTML = exportBtn.innerHTML;

            if (!logoUrl) {
                showNotification('Por favor, sube un logo para usarlo como marca de agua.', 'error');
                return;
            }

            exportBtn.disabled = true;
            exportBtn.innerHTML = `${spinnerSVG} Generando...`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'pdf-report pdf-watermark';
            contentDiv.style.setProperty('--watermark-image', `url('${logoUrl}')`);
            contentDiv.style.setProperty('--watermark-opacity', watermarkOpacity);
            contentDiv.style.position = 'relative';


            const section = document.getElementById('export-section').value;
            const companyNameElement = `<div class="text-center mb-8"><h2 class="text-3xl font-bold text-primary-600 dark:text-primary-500 mb-2">${companyName}</h2><p class="text-lg text-gray-500 dark:text-gray-400">Periodo: ${reportPeriod}</p></div>`;

            const watermarkHtml = watermarkText ? `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 5rem; color: rgba(0,0,0,${watermarkOpacity * 2}); opacity: 0.1; z-index: 1000; pointer-events: none;">${watermarkText}</div>` : '';

            let reportContentHtml = `<div style="position: relative; z-index: 2;">${companyNameElement}`;

            if (financialData.analysis.summary) {
                reportContentHtml += `<div class="ai-analysis-container bg-primary-50 dark:bg-primary-900 border border-primary-200 dark:border-primary-800 p-6 rounded-xl mt-8 mb-8"><h4 class="text-lg font-semibold text-primary-600 dark:text-primary-500">✨ Resumen Ejecutivo por IA</h4><p class="mt-2 text-sm leading-relaxed">${financialData.analysis.summary.replace(/\n/g, '<br>')}</p></div>`;
            }

            if (section === 'full' || section === 'balance') {
                if (financialData.balance.totals) {
                    const {
                        activosHtml,
                        pasivosHtml
                    } = generateBalanceTablesHtml(financialData.balance, true);
                    reportContentHtml += `<div class="mb-8"><h3 class="text-2xl font-semibold pb-2 mb-4 border-b-2">Balance General</h3><div class="flex flex-col md:flex-row gap-4"><div class="flex-1">${activosHtml}</div><div class="flex-1">${pasivosHtml}</div></div></div>`;
                }
            }

            if (section === 'full' || section === 'results') {
                if (financialData.results.totals) {
                    const resultsSection = `<div class="mb-8"><h3 class="text-2xl font-semibold pb-2 mb-4 border-b-2">Estado de Resultados</h3>${generateResultsTableHtml(financialData.results, true)}</div>`;
                    reportContentHtml += resultsSection;
                }
            }

            if (section === 'full' || section === 'ratios') {
                if (financialData.ratios && Object.keys(financialData.ratios).length > 0) {
                    const ratios = financialData.ratios;
                    const ratiosSection = `<div class="mb-8"><h3 class="text-2xl font-semibold pb-2 mb-4 border-b-2">Ratios Financieros Clave</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"><div class="bg-gray-100 p-4 rounded-lg border-l-4 border-primary-600 shadow-sm"><h4 class="text-xs font-semibold text-gray-500">Razón Corriente</h4><p class="text-xl font-bold">${ratios.currentRatio.toFixed(2)}</p></div><div class="bg-gray-100 p-4 rounded-lg border-l-4 border-primary-600 shadow-sm"><h4 class="text-xs font-semibold text-gray-500">ROE</h4><p class="text-xl font-bold">${(ratios.roe * 100).toFixed(2)}%</p></div><div class="bg-gray-100 p-4 rounded-lg border-l-4 border-primary-600 shadow-sm"><h4 class="text-xs font-semibold text-gray-500">Margen Neto</h4><p class="text-xl font-bold">${(ratios.netMargin * 100).toFixed(2)}%</p></div></div></div>`;
                    reportContentHtml += ratiosSection;
                }
            }
            if (section === 'full' || section === 'comprobacion') {
                if (financialData.balance.totals && financialData.results.totals) {
                    const { totalAssets, totalLiabilitiesEquity, totalEquity } = financialData.balance.totals;
                    const { netIncome } = financialData.results.totals;
                    const accountingEquationCheck = Math.abs(totalAssets - totalLiabilitiesEquity) < 0.01;
                    const netIncomeCheck = Math.abs(netIncome - getValue('current-period-result')) < 0.01;

                    const comprobacionHtml = `
                    <div class="mb-8">
                        <h3 class="text-2xl font-semibold pb-2 mb-4 border-b-2">Comprobación de Estados</h3>
                        <div class="space-y-4">
                            <div class="p-4 rounded-lg flex items-center gap-3 ${accountingEquationCheck ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${accountingEquationCheck ? 'text-green-500' : 'text-red-500'}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="${accountingEquationCheck ? 'M5 13l4 4L19 7' : 'M6 18L18 6M6 6l12 12'}" />
                                </svg>
                                <div>
                                    <h4 class="font-bold">Ecuación Contable (Activo = Pasivo + Patrimonio)</h4>
                                    <p class="text-sm">Resultado: ${accountingEquationCheck ? '¡Los estados cuadran!' : '¡Los estados no cuadran!'}</p>
                                    <p class="text-sm">Activo: ${formatCurrency(totalAssets)}</p>
                                    <p class="text-sm">Pasivo + Patrimonio: ${formatCurrency(totalLiabilitiesEquity)}</p>
                                </div>
                            </div>
                            <div class="p-4 rounded-lg flex items-center gap-3 ${netIncomeCheck ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${netIncomeCheck ? 'text-green-500' : 'text-red-500'}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="${netIncomeCheck ? 'M5 13l4 4L19 7' : 'M6 18L18 6M6 6l12 12'}" />
                                </svg>
                                <div>
                                    <h4 class="font-bold">Conciliación del Resultado del Ejercicio</h4>
                                    <p class="text-sm">Resultado: ${netIncomeCheck ? '¡La utilidad neta coincide!' : '¡La utilidad neta no coincide!'}</p>
                                    <p class="text-sm">Utilidad Neta (Estado de Resultados): ${formatCurrency(netIncome)}</p>
                                    <p class="text-sm">Resultado del Ejercicio (Balance): ${formatCurrency(getValue('current-period-result'))}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                    reportContentHtml += comprobacionHtml;
                } else {
                    reportContentHtml += `<div class="mb-8"><h3 class="text-2xl font-semibold pb-2 mb-4 border-b-2">Comprobación de Estados</h3><p class="text-gray-500 text-sm">Sin datos para comprobar. Calcula el balance y los resultados primero.</p></div>`;
                }
            }


            reportContentHtml += `</div>`;
            contentDiv.innerHTML = reportContentHtml;

            const coverBackground = document.getElementById('cover-background').value;
            let coverHtml = '';
            if (coverBackground === 'solid') {
                coverHtml = `
                    <div class="pdf-cover" style="width: 100%; height: 100vh; display: flex; align-items: center; justify-content: center; text-align: center; page-break-after: always; color: white;">
                        <div>
                            ${logoUrl ? `<img src="${logoUrl}" alt="Company Logo" style="width: 150px; height: 150px; margin: 0 auto 20px; border-radius: 50%; border: 4px solid white;">` : ''}
                            <h1 class="pdf-cover-text text-4xl font-extrabold">${companyName}</h1>
                            <p class="pdf-cover-text text-xl font-light mt-4">Reporte Financiero</p>
                            <p class="pdf-cover-text text-xl font-light">${reportPeriod}</p>
                        </div>
                    </div>
                `;
            } else {
                coverHtml = `
                    <div class="pdf-cover" style="width: 100%; height: 100vh; display: flex; align-items: center; justify-content: center; text-align: center; page-break-after: always; color: white; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect x="0" y="0" width="100" height="100" fill="%23f0f9ff" /><path d="M50 0L100 50L50 100L0 50Z" fill="%23e0f2fe" opacity="0.3" /></svg>'); background-size: 100px 100px;">
                        <div>
                            ${logoUrl ? `<img src="${logoUrl}" alt="Company Logo" style="width: 150px; height: 150px; margin: 0 auto 20px; border-radius: 50%; border: 4px solid white;">` : ''}
                            <h1 class="pdf-cover-text text-4xl font-extrabold">${companyName}</h1>
                            <p class="pdf-cover-text text-xl font-light mt-4">Reporte Financiero</p>
                            <p class="pdf-cover-text text-xl font-light">${reportPeriod}</p>
                        </div>
                    </div>
                `;
            }
            contentDiv.prepend(htmlToElement(coverHtml));

            html2pdf().from(contentDiv).set({
                margin: 10,
                filename: `${companyName}_Reporte_Financiero_${reportPeriod}.pdf`,
                html2canvas: {
                    scale: 2,
                    letterRendering: true,
                    useCORS: true
                },
                jsPDF: {
                    unit: 'mm',
                    format: 'a4',
                    orientation: 'portrait'
                }
            }).save().then(() => {
                exportBtn.disabled = false;
                exportBtn.innerHTML = originalBtnHTML;
                showNotification('Reporte exportado como PDF.', 'success');
            });
        }

        function exportCSV() {
            const section = document.getElementById('export-section').value;
            let csv = '';
            const companyName = getTextValue('company-name') || 'Reporte Financiero';
            const reportPeriod = getTextValue('report-period') || 'N/A';
            const headers = "Concepto,Monto\n";

            if (section === 'full' || section === 'balance') {
                if (financialData.balance.totals) {
                    const bt = financialData.balance.totals;
                    csv += "Balance General\n";
                    csv += headers;
                    csv += `TOTAL ACTIVO CORRIENTE,${bt.currentAssetsTotal}\n`;
                    csv += `TOTAL ACTIVO NO CORRIENTE,${bt.nonCurrentAssetsTotal}\n`;
                    csv += `TOTAL ACTIVO,${bt.totalAssets}\n`;
                    csv += `TOTAL PASIVO CORRIENTE,${bt.currentLiabilitiesTotal}\n`;
                    csv += `TOTAL PASIVO NO CORRIENTE,${bt.longTermLiabilitiesTotal}\n`;
                    csv += `TOTAL PASIVO,${bt.totalLiabilities}\n`;
                    csv += `TOTAL PATRIMONIO,${bt.totalEquity}\n`;
                    csv += `TOTAL PASIVO Y PATRIMONIO,${bt.totalLiabilitiesEquity}\n`;
                }
            }

            if (section === 'full' || section === 'results') {
                if (financialData.results.totals) {
                    const rt = financialData.results.totals;
                    csv += "\nEstado de Resultados\n";
                    csv += headers;
                    csv += `Ventas Netas,${rt.netSales}\n`;
                    csv += `Costo de Ventas,${rt.costOfSales}\n`;
                    csv += `Utilidad Bruta,${rt.grossProfit}\n`;
                    csv += `Gastos de Operacion,${rt.totalOperatingExpenses}\n`;
                    csv += `Utilidad Operativa,${rt.operatingProfit}\n`;
                    csv += `Gastos Financieros,${rt.totalFinancialExpenses}\n`;
                    csv += `Utilidad antes de Impuestos,${rt.profitBeforeTax}\n`;
                    csv += `Impuestos,${rt.totalTaxes}\n`;
                    csv += `UTILIDAD NETA,${rt.netIncome}\n`;
                }
            }
            if (section === 'full' || section === 'comprobacion') {
                if (financialData.balance.totals && financialData.results.totals) {
                    const bt = financialData.balance.totals;
                    const rt = financialData.results.totals;
                    csv += "\nComprobación de Estados\n";
                    csv += headers;
                    csv += `Ecuación Contable (Activo vs Pasivo+Patrimonio),${Math.abs(bt.totalAssets - bt.totalLiabilitiesEquity) < 0.01 ? 'Cuadra' : 'No Cuadra'}\n`;
                    csv += `Conciliación del Resultado (Utilidad Neta vs Resultado del Ejercicio),${Math.abs(rt.netIncome - getValue('current-period-result')) < 0.01 ? 'Cuadra' : 'No Cuadra'}\n`;
                }
            }

            const blob = new Blob([csv], {
                type: 'text/csv;charset=utf-8;'
            });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `${companyName}_Reporte_Financiero_${reportPeriod}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('Reporte exportado como CSV.', 'success');
        }

        // --- Data Handling ---
        function loadSampleBalanceData() {
            document.getElementById('cash').value = '150000';
            document.getElementById('banks').value = '350000';
            document.getElementById('short-term-investments').value = '50000';
            document.getElementById('domestic-clients').value = '200000';
            document.getElementById('foreign-clients').value = '100000';
            document.getElementById('notes-receivable').value = '20000';
            document.getElementById('bad-debt-provision').value = '5000';
            document.getElementById('raw-materials').value = '120000';
            document.getElementById('work-in-progress').value = '80000';
            document.getElementById('finished-goods').value = '150000';
            document.getElementById('goods-in-transit').value = '30000';
            document.getElementById('tax-refunds').value = '15000';
            document.getElementById('interest-receivable').value = '5000';
            document.getElementById('supplier-advances').value = '10000';
            document.getElementById('other-current-assets').value = '8000';
            document.getElementById('land').value = '500000';
            document.getElementById('buildings').value = '800000';
            document.getElementById('machinery').value = '350000';
            document.getElementById('furniture').value = '100000';
            document.getElementById('transportation-equipment').value = '200000';
            document.getElementById('accumulated-depreciation').value = '250000';
            document.getElementById('trademarks-patents').value = '120000';
            document.getElementById('licenses').value = '80000';
            document.getElementById('software').value = '60000';
            document.getElementById('accumulated-amortization').value = '40000';
            document.getElementById('investment-shares').value = '250000';
            document.getElementById('bonds').value = '150000';
            document.getElementById('other-investments').value = '50000';
            document.getElementById('domestic-suppliers').value = '150000';
            document.getElementById('foreign-suppliers').value = '80000';
            document.getElementById('notes-payable').value = '40000';
            document.getElementById('short-term-bank-loans').value = '200000';
            document.getElementById('bank-overdrafts').value = '30000';
            document.getElementById('vat-payable').value = '25000';
            document.getElementById('income-tax-payable').value = '15000';
            document.getElementById('other-taxes').value = '5000';
            document.getElementById('customer-advances').value = '10000';
            document.getElementById('provisions').value = '20000';
            document.getElementById('dividends-payable').value = '10000';
            document.getElementById('other-current-liabilities').value = '8000';
            document.getElementById('long-term-bank-loans').value = '400000';
            document.getElementById('finance-lease-obligations').value = '100000';
            document.getElementById('other-long-term-liabilities').value = '20000';
            document.getElementById('capital-stock').value = '1000000';
            document.getElementById('share-premium').value = '100000';
            document.getElementById('legal-reserves').value = '50000';
            document.getElementById('voluntary-reserves').value = '25000';
            document.getElementById('accumulated-results').value = '150000';
            document.getElementById('current-period-result').value = '391000'; // Ajustado para que cuadre
            showNotification('Datos de ejemplo cargados en el Balance General.', 'info');
            // Format inputs immediately after loading data
            document.querySelectorAll('#balance input[type="text"]').forEach(input => {
                if (input.value) {
                    input.value = formatCurrency(parseFloat(input.value));
                }
            });
            calculateBalance();
        }

        function loadSampleResultsData() {
            document.getElementById('gross-sales').value = '5000000';
            document.getElementById('sales-returns').value = '50000';
            document.getElementById('sales-discounts').value = '20000';
            document.getElementById('bonuses').value = '10000';
            document.getElementById('rental-income').value = '5000';
            document.getElementById('financial-income').value = '1000';
            document.getElementById('asset-sale-gain').value = '20000';
            document.getElementById('other-income').value = '10000';
            document.getElementById('beginning-inventory').value = '100000';
            document.getElementById('net-purchases').value = '1500000';
            document.getElementById('ending-inventory').value = '150000';
            document.getElementById('finished-goods-cost').value = '0';
            document.getElementById('sales-salaries').value = '800000';
            document.getElementById('sales-commissions').value = '150000';
            document.getElementById('advertising').value = '100000';
            document.getElementById('freight-out').value = '50000';
            document.getElementById('other-sales-expenses').value = '20000';
            document.getElementById('admin-salaries').value = '600000';
            document.getElementById('professional-fees').value = '80000';
            document.getElementById('general-services').value = '50000';
            document.getElementById('office-maintenance').value = '30000';
            document.getElementById('depreciation-expense').value = '250000';
            document.getElementById('amortization-expense').value = '40000';
            document.getElementById('other-admin-expenses').value = '10000';
            document.getElementById('interest-expense').value = '15000';
            document.getElementById('bank-commissions').value = '5000';
            document.getElementById('exchange-loss').value = '2000';
            document.getElementById('other-financial-expenses').value = '1000';
            document.getElementById('income-tax').value = '120000';
            document.getElementById('other-taxes-expense').value = '5000';
            showNotification('Datos de ejemplo cargados en el Estado de Resultados.', 'info');
            // Format inputs immediately after loading data
            document.querySelectorAll('#resultados input[type="text"]').forEach(input => {
                if (input.value) {
                    input.value = formatCurrency(parseFloat(input.value));
                }
            });
            calculateResults();
        }

        function loadSampleComparisonData() {
            document.getElementById('period1-name').value = 'Jun 2025';
            document.getElementById('period1-net-income').value = '150000';
            document.getElementById('period1-sales').value = '1000000';
            document.getElementById('period2-name').value = 'Jul 2025';
            document.getElementById('period2-net-income').value = '200000';
            document.getElementById('period2-sales').value = '1200000';
            showNotification('Datos de ejemplo cargados para el Comparativo.', 'info');
        }

        // --- Event Listeners and UI Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tab = button.getAttribute('data-tab');
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(tab).classList.remove('hidden');

                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active', 'bg-primary-600', 'dark:bg-primary-500', 'text-white', 'font-semibold');
                        btn.classList.add('text-gray-300');
                    });
                    button.classList.add('active', 'bg-primary-600', 'dark:bg-primary-500', 'text-white', 'font-semibold');
                    button.classList.remove('text-gray-300');
                    showTabInstruction(tab);
                });
            });

            // Add event listeners to format currency on input blur
            document.querySelectorAll('input[type="text"]').forEach(input => {
                input.addEventListener('blur', (event) => {
                    if (event.target.value) {
                        const numericValue = parseFloat(event.target.value.replace(/[^0-9.-]+/g, "")) || 0;
                        event.target.value = formatCurrency(numericValue);
                    }
                });
            });

            document.getElementById('mobile-menu-toggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('open');
            });

            document.getElementById('theme-toggle').addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isDarkMode = document.documentElement.classList.contains('dark');
                document.getElementById('sun-icon').classList.toggle('hidden', isDarkMode);
                document.getElementById('moon-icon').classList.toggle('hidden', !isDarkMode);
            });

            document.getElementById('logo-upload-container').addEventListener('click', () => {
                document.getElementById('company-logo').click();
            });

            document.getElementById('company-logo').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        if (logoObjectURL) {
                            URL.revokeObjectURL(logoObjectURL);
                        }
                        logoObjectURL = URL.createObjectURL(file);
                        document.getElementById('preview-logo').innerHTML = `<img src="${e.target.result}" alt="Company Logo" class="w-full h-full object-contain rounded-full">`;
                        showNotification('Logo subido correctamente.', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('company-name').addEventListener('input', (event) => {
                document.getElementById('preview-company-name').textContent = event.target.value || 'Nombre de la Empresa';
            });
            document.getElementById('report-period').addEventListener('input', (event) => {
                document.getElementById('preview-period').textContent = `Periodo: ${event.target.value || 'YYYY-MM'}`;
            });

            document.getElementById('ai-summary-btn').addEventListener('click', () => {
                // Llama a la API de Gemini para el resumen
                const data = {
                    balance: financialData.balance.totals,
                    results: financialData.results.totals
                };
                callGeminiAPI('summary', data);
            });
            document.getElementById('ai-swot-btn').addEventListener('click', () => {
                // Llama a la API de Gemini para el análisis SWOT
                const data = {
                    balance: financialData.balance.totals,
                    results: financialData.results.totals
                };
                callGeminiAPI('swot', data);
            });
            document.getElementById('ai-recom-btn').addEventListener('click', () => {
                // Llama a la API de Gemini para las recomendaciones
                const data = {
                    balance: financialData.balance.totals,
                    results: financialData.results.totals
                };
                callGeminiAPI('recommendations', data);
            });
        });

        // Función auxiliar para convertir HTML string a elemento DOM
        function htmlToElement(html) {
            const template = document.createElement('template');
            html = html.trim();
            template.innerHTML = html;
            return template.content.firstChild;
        }

        async function callGeminiAPI(type, data) {
            const resultDisplay = document.getElementById('ai-result-display');
            const btn = document.getElementById(`ai-${type}-btn`);
            const originalBtnText = btn.innerHTML;
            const messageDiv = document.getElementById('ai-message');
            messageDiv.innerHTML = '';

            if (!data.balance || !data.results) {
                showNotification('Por favor, calcula primero el Balance General y el Estado de Resultados.', 'error');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `${spinnerSVG} Analizando...`;
            resultDisplay.value = 'Generando análisis con IA...';

            let userPrompt = '';
            switch (type) {
                case 'summary':
                    userPrompt = `Actúa como un analista financiero experto. Proporciona un resumen ejecutivo de un párrafo sobre el desempeño de la empresa. Utiliza los siguientes datos financieros:\nBalance General: ${JSON.stringify(data.balance)}\nEstado de Resultados: ${JSON.stringify(data.results)}\n`;
                    break;
                case 'swot':
                    userPrompt = `Actúa como un consultor de negocios. Con base en los siguientes datos financieros, identifica las principales fortalezas y debilidades de la empresa en formato de lista. Utiliza los siguientes datos:\nBalance General: ${JSON.stringify(data.balance)}\nEstado de Resultados: ${JSON.stringify(data.results)}\n`;
                    break;
                case 'recommendations':
                    userPrompt = `Actúa como un asesor financiero. Proporciona 3-5 recomendaciones clave para mejorar la salud financiera de la empresa, basadas en los siguientes datos:\nBalance General: ${JSON.stringify(data.balance)}\nEstado de Resultados: ${JSON.stringify(data.results)}\n`;
                    break;
            }

            const payload = {
                contents: [{
                    parts: [{
                        text: userPrompt
                    }]
                }],
                tools: [{
                    "google_search": {}
                }],
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    financialData.analysis[type] = text;
                    resultDisplay.value = text;
                    showNotification('Análisis generado exitosamente.', 'success');
                } else {
                    throw new Error('No se pudo generar el análisis.');
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showNotification(`Error al generar el análisis: ${error.message}`, 'error');
                resultDisplay.value = 'Ocurrió un error al generar el análisis. Por favor, inténtalo de nuevo.';
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
            }
        }

        async function generateAIBenchmarkAnalysis() {
            const industry = getTextValue('industry-input');
            const resultDisplay = document.getElementById('ai-result-display');
            const btn = document.getElementById('ai-benchmark-btn');
            const originalBtnText = btn.innerHTML;
            const messageDiv = document.getElementById('ai-message');
            messageDiv.innerHTML = '';

            if (!industry) {
                showNotification('Por favor, introduce la industria para realizar el benchmarking.', 'error');
                return;
            }

            if (!financialData.ratios || Object.keys(financialData.ratios).length === 0) {
                showNotification('Calcula los ratios financieros primero.', 'error');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `${spinnerSVG} Analizando...`;
            resultDisplay.value = 'Generando análisis de benchmarking con IA...';

            const userPrompt = `Compara los siguientes ratios financieros de una empresa con los promedios de la industria de ${industry}. Proporciona un análisis conciso y claro de las fortalezas y debilidades relativas de la empresa. Utiliza los siguientes ratios:\n${JSON.stringify(financialData.ratios)}\n`;

            const payload = {
                contents: [{
                    parts: [{
                        text: userPrompt
                    }]
                }],
                tools: [{
                    "google_search": {}
                }],
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    financialData.analysis.benchmark = text;
                    resultDisplay.value = text;
                    showNotification('Análisis de benchmarking generado exitosamente.', 'success');
                } else {
                    throw new Error('No se pudo generar el análisis.');
                }
            } catch (error) {
                console.error("Error calling Gemini API for benchmarking:", error);
                showNotification(`Error al generar el análisis de benchmarking: ${error.message}`, 'error');
                resultDisplay.value = 'Ocurrió un error al generar el análisis. Por favor, inténtalo de nuevo.';
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
            }
        }


        window.enterApp = function () {
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('main-app-container').classList.remove('hidden');
            setTimeout(showWelcomeNotification, 500);
        }
    </script>
</body>

</html>